(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();class te{constructor(e,t,s){this.auth=e,this.database=t,this.getUserDisplayName=s,this.unreadMessageCount=0,this.isChatVisible=!1,this.chatNotificationSound=null,this.chatListener=null,this.currentGameId=null,this.lastMessageTime=0,this.MESSAGE_COOLDOWN=1e3,this.chatBox=document.getElementById("chat-box"),this.chatMessages=document.getElementById("chat-messages"),this.chatForm=document.getElementById("chat-form"),this.chatInput=document.getElementById("chat-input"),this.notificationBadge=document.getElementById("chat-notification-badge"),this.tabNotificationBadge=document.getElementById("chat-tab-notification-badge")}init(){this.chatForm&&this.chatForm.addEventListener("submit",async t=>{t.preventDefault();const s=this.chatInput.value.trim();s&&(await this.sendChatMessage(s),this.chatInput.value="")}),["focus","click","scroll"].forEach(t=>{this.chatInput&&this.chatInput.addEventListener(t,()=>this.clearChatNotifications()),this.chatMessages&&this.chatMessages.addEventListener(t,()=>this.clearChatNotifications()),this.chatBox&&this.chatBox.addEventListener(t,()=>this.clearChatNotifications())})}setupListener(e){if(!e)return;this.cleanupListener(),this.currentGameId=e;const t=this.database.ref(`games/${this.currentGameId}/chat`);this.chatMessages&&(this.chatMessages.innerHTML=""),this.unreadMessageCount=0,this.updateChatNotificationBadge();const s=Date.now()-3e3;this.chatListener=t.limitToLast(50).on("child_added",a=>{const i=a.val();if(!i)return;this.displayChatMessage(i);const r=this.auth.currentUser;!(r&&i.uid===r.uid)&&i.timestamp>s&&this.showChatNotification()})}cleanupListener(){this.chatListener&&this.currentGameId&&this.database.ref(`games/${this.currentGameId}/chat`).off("child_added",this.chatListener),this.chatListener=null,this.currentGameId=null,this.chatMessages&&(this.chatMessages.innerHTML=""),this.clearChatNotifications()}async sendChatMessage(e){if(!this.currentGameId||!e)return;const t=this.auth.currentUser;if(!t)return;const s=Date.now(),a=s-this.lastMessageTime;if(a<this.MESSAGE_COOLDOWN){const o=Math.ceil((this.MESSAGE_COOLDOWN-a)/1e3);typeof window.showToast=="function"&&window.showToast(`√áok hƒ±zlƒ± mesaj g√∂nderiyorsunuz! ${o} saniye bekleyin.`,"warning",2e3);return}this.lastMessageTime=s;const i=await this.getUserDisplayName(t),r={uid:t.uid,senderName:i,text:e,timestamp:firebase.database.ServerValue.TIMESTAMP};await this.database.ref(`games/${this.currentGameId}/chat`).push(r)}_initChatNotificationSound(){this.chatNotificationSound||(this.chatNotificationSound=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKvl8bllHQU3k9nzzn0vBSl+zPLaizsKElyx6OyrWBYKQ5zd8sFuJAUqgM7y2Ik2CBxqu/DjnE4NEFWs5/K3ZB4EOpXb88yAMQUng8/y2Ys5ChJctOrtrVkXCkGb3PLCcCUFK4DN8tiKNQgbarvw45xPDBBUq+fyt2QeBTuU2/POgDEFJ4PP8tyLOQoTXLPq7axZGApCnNzywnAmBSuAzvLYijUIHGq68OOcTwwQVKzn8rdkHwU7lNvzzn8xBSiEz/LcizsKElyx6u2sWRgLQpvb88JwJgUrgc7y2Yo2CBxquvDjnE4MEFSr5/G4ZR4FPJXZ886BMQUohM/y3Is7ChJctOrtq1kXC0Ka3PLCbyYFK4HO8tmJNggbarvw4pxOCxFVrOjxtmQeBD2V2fPOgDAFKYTP8tyLOQoSXLPq7axYGApDnN3yw28mBSt/zvHYijUIHGm68OKcTQwRVavk8LZkHgQ9lNnzznwwBSmFz/LaizoKElux6OyrWBgKQ5va88NwJwUrfszx2IszCBxouO/hmk0MEFWq5PC2Yx4EPZTa886AMgUphc/y2os6ChBbsOjsqVcXCkKZ2/LBbyYFK3/N8dmJNwgcaLrv4ZpMDRBWrOTwtmQeBDyS2/LNfzEFKIXP8tqLOwoSXLDp7alXFgtDmtvywW8lBSuAzfHYiTcJGmm77+GaTQ0PVqzk8LVkHgQ8lNvzzX8yBSeEz/Laizr7xo+N"))}showChatNotification(){this.chatBox&&!this.chatBox.classList.contains("hidden")||(this.unreadMessageCount++,this.updateChatNotificationBadge(),this._initChatNotificationSound(),this.chatNotificationSound&&(this.chatNotificationSound.volume=.3,this.chatNotificationSound.play().catch(()=>{})),navigator.vibrate&&navigator.vibrate([100,50,100]))}updateChatNotificationBadge(){[this.notificationBadge,this.tabNotificationBadge].forEach(t=>{t&&(this.unreadMessageCount>0?(t.textContent=this.unreadMessageCount>9?"9+":this.unreadMessageCount,t.classList.remove("hidden")):t.classList.add("hidden"))})}clearChatNotifications(){this.unreadMessageCount=0,this.updateChatNotificationBadge()}displayChatMessage(e){if(!this.chatMessages)return;const t=this.auth.currentUser,s=t&&e.uid===t.uid,a=new Date(e.timestamp).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}),i=document.createElement("div");i.className=`flex ${s?"justify-end":"justify-start"} animate-fadeIn`,i.innerHTML=`
            <div class="max-w-[80%] ${s?"bg-amber-600":"bg-slate-700"} rounded-lg px-3 py-2">
                <div class="flex items-baseline gap-2 mb-1">
                    <span class="font-semibold text-sm ${s?"text-white":"text-amber-300"}">${e.senderName}</span>
                    <span class="text-xs opacity-70">${a}</span>
                </div>
                <p class="text-sm text-white break-words">${this._escapeHtml(e.text)}</p>
            </div>
        `,this.chatMessages.appendChild(i),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}_escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,s=>t[s])}}const K=b=>{const e=Math.floor(b/1e3),t=Math.floor(e/3600),s=Math.floor(e%3600/60),a=e%60;return`${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`},Z=b=>{const e=Math.floor(b/1e3),t=Math.floor(e/60),s=e%60;return`${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}`},W=(b,e="info",t=3e3)=>{const s=document.getElementById("toast-container");if(!s)return;const a={success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"},i={success:"Ba≈üarƒ±lƒ±",error:"Hata",warning:"Uyarƒ±",info:"Bilgi"},r=document.createElement("div");r.className=`toast toast-${e}`,r.style.setProperty("--toast-duration",`${t}ms`);const n=()=>{r.classList.add("removing"),r.addEventListener("animationend",()=>{r.remove()})};r.innerHTML=`
        <div class="toast-icon">${a[e]||a.info}</div>
        <div class="toast-content">
            <div class="toast-title">${i[e]||i.info}</div>
            <div class="toast-message">${b}</div>
        </div>
        <button class="toast-close">√ó</button>
        <div class="toast-progress" style="animation-duration: ${t}ms;"></div>
    `,r.querySelector(".toast-close").addEventListener("click",n),s.appendChild(r),setTimeout(()=>{r.classList.add("show")},10);const o=setTimeout(n,t);r.addEventListener("mouseenter",()=>clearTimeout(o)),r.addEventListener("mouseleave",()=>setTimeout(n,t))},ee=(b,e="Emin misiniz?")=>new Promise(t=>{const s=document.getElementById("confirm-dialog"),a=document.getElementById("confirm-title"),i=document.getElementById("confirm-message"),r=document.getElementById("confirm-ok"),n=document.getElementById("confirm-cancel");if(!s||!a||!i||!r||!n){t(window.confirm(b));return}a.textContent=e,i.textContent=b,s.classList.remove("hidden");const o=()=>{s.classList.add("hidden"),r.removeEventListener("click",l),n.removeEventListener("click",d),s.removeEventListener("click",c)},l=()=>{o(),t(!0)},d=()=>{o(),t(!1)},c=u=>{u.target===s&&d()};r.addEventListener("click",l),n.addEventListener("click",d),s.addEventListener("click",c)}),ae=()=>{window.alert=b=>{W(b,"info",3e3)},window.confirm=ee};class se{constructor(e,t,s){this.database=e,this.auth=t,this.gameManager=s,this.started=!1,this.gameStartTime=null,this.currentTurnStartTime=null,this.playerTurnTimes={},this.currentTurnUid=null,this.timerInterval=null,this.statsUpdated={}}startGameTimers(e,t=0){e&&(this.started&&this.resetGameTimers(),this.started=!0,this.gameStartTime=Date.now(),this.playerTurnTimes={},e.forEach(s=>{this.playerTurnTimes[s.uid]=0}),e[t]&&(this.currentTurnUid=e[t].uid,this.currentTurnStartTime=Date.now()),this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{this.updateGameTimerUI(),this.updateScoreboardTimers()},1e3))}stopGameTimers(){if(this.currentTurnUid&&this.currentTurnStartTime){const e=Date.now()-this.currentTurnStartTime;this.playerTurnTimes[this.currentTurnUid]=(this.playerTurnTimes[this.currentTurnUid]||0)+e}this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}resetGameTimers(){this.stopGameTimers(),this.started=!1,this.gameStartTime=null,this.currentTurnStartTime=null,this.playerTurnTimes={},this.currentTurnUid=null;const e=document.getElementById("game-timer");e&&(e.textContent="00:00:00")}updateGameTimerUI(){const e=document.getElementById("game-timer");if(!e||!this.gameStartTime)return;const t=Date.now()-this.gameStartTime;e.textContent=K(t)}updateScoreboardTimers(){if(!this.gameManager||!this.gameManager.players)return;const e=window.practiceMode&&window.practiceMode.active;this.gameManager.players.forEach((t,s)=>{var i;const a=(i=this.gameManager.scoreboardCache)==null?void 0:i.get(t.uid);if(a)if(e){const r=this.gameStartTime?Date.now()-this.gameStartTime:0;a.totalTime&&(a.totalTime.textContent=Z(r))}else{let n=this.playerTurnTimes[t.uid]||0;s===this.gameManager.currentPlayerIndex&&this.currentTurnStartTime&&this.currentTurnUid===t.uid&&(n+=Date.now()-this.currentTurnStartTime),a.turnTime&&(a.turnTime.textContent=Z(n))}})}trackTurnChange(e){if(!this.started||!e)return;const t=e.players&&e.players[e.currentPlayerIndex]?e.players[e.currentPlayerIndex].uid:null;if(t){if(!this.currentTurnUid){this.currentTurnUid=t,this.currentTurnStartTime=Date.now();return}if(t!==this.currentTurnUid){if(this.currentTurnStartTime){const s=Date.now()-this.currentTurnStartTime;this.playerTurnTimes[this.currentTurnUid]=(this.playerTurnTimes[this.currentTurnUid]||0)+s}this.currentTurnUid=t,this.currentTurnStartTime=Date.now()}}}async updatePlayerStats(e,t){if(!this.auth.currentUser||!t||this.statsUpdated[e]||window.practiceMode&&window.practiceMode.active)return;this.statsUpdated[e]=!0,this.stopGameTimers();const s=this.auth.currentUser.uid,a=t.players||[],i=this.gameStartTime?Date.now()-this.gameStartTime:0,r=this.playerTurnTimes[s]||0,n=Math.max(...a.map(u=>u.score||0)),o=a.filter(u=>(u.score||0)===n);let l=0;o.find(u=>u.uid===s)&&(l=o.length===1?3:1);const c=this.database.ref(`users/${s}/stats`);try{await c.transaction(u=>{const h=u||{};return h.totalPoints=(h.totalPoints||0)+l,h.totalGameTime=(h.totalGameTime||0)+i,h.totalTurnTime=(h.totalTurnTime||0)+r,h.gamesPlayed=(h.gamesPlayed||0)+1,l===3?h.wins=(h.wins||0)+1:l===1?h.draws=(h.draws||0)+1:h.losses=(h.losses||0)+1,h.lastUpdated=Date.now(),h})}catch(u){console.error("‚ùå Error updating player stats:",u)}}}class ie{constructor(e,t,s){this.canvas=e,this.ctx=t,this.container=s,this.coinImages=[],this.coinImageAssignments={},this.imagePaths=["images/ancient-coin01.png","images/ancient-coin02.png","images/ancient-coin03.png","images/ancient-coin04.png","images/ancient-coin05.png","images/ancient-coin06.png"],this.woodPattern=null,this.LOGICAL_WIDTH=600,this.LOGICAL_HEIGHT=1e3,this.COIN_DIAMETER_RATIO=.1,this.GOAL_WIDTH_RATIO=.3}setConstants(e){this.LOGICAL_WIDTH=e.LOGICAL_WIDTH,this.LOGICAL_HEIGHT=e.LOGICAL_HEIGHT,this.COIN_DIAMETER_RATIO=e.COIN_DIAMETER_RATIO,this.GOAL_WIDTH_RATIO=e.GOAL_WIDTH_RATIO}draw(e,t){const s=this.canvas.width,a=this.canvas.height;this.ctx.clearRect(0,0,s,a),this.ctx.save(),this.ctx.fillStyle=this.woodPattern?"#a0522d":"#8B4513",this.ctx.fillRect(0,0,s,a),this.woodPattern&&(this.ctx.globalAlpha=.2,this.ctx.fillStyle=this.woodPattern,this.ctx.fillRect(0,0,s,a),this.ctx.globalAlpha=1);const i=(.5-this.GOAL_WIDTH_RATIO/2)*s,r=this.GOAL_WIDTH_RATIO*s,n=40,o=.5-this.GOAL_WIDTH_RATIO/2,l=.5+this.GOAL_WIDTH_RATIO/2;e.forEach(d=>{(d.y>0||d.x<o||d.x>l)&&this.drawCoin(d)}),this.drawGoal(i,r,n),e.forEach(d=>{d.y<=0&&d.x>=o&&d.x<=l&&this.drawCoin(d)}),t.isDragging&&t.selectedCoin&&this.drawAimingLine(t.selectedCoin,t.dragStart,t.dragEnd),this.ctx.restore()}drawGoal(e,t,s){const a=this.ctx;a.fillStyle="rgba(0, 0, 0, 0.4)",a.fillRect(e,0,t,s),a.strokeStyle="rgba(255, 255, 255, 0.35)",a.lineWidth=1;for(let i=0;i<=s;i+=8)a.beginPath(),a.moveTo(e,i),a.lineTo(e+t,i),a.stroke();for(let i=e;i<=e+t;i+=8)a.beginPath(),a.moveTo(i,0),a.lineTo(i,s),a.stroke();a.fillStyle="#FFFFFF",a.fillRect(e-3,0,3,s+3),a.fillRect(e+t,0,3,s+3),a.fillRect(e-3,0,t+6,3)}drawCoin(e){const t=this.canvas.width,s=e.x*t,a=e.y*t,i=this.COIN_DIAMETER_RATIO/2*t,r=this.coinImageAssignments[e.id];r&&r.complete&&r.naturalWidth>0?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s,a,i,0,Math.PI*2,!0),this.ctx.clip(),this.ctx.drawImage(r,s-i,a-i,i*2,i*2),this.ctx.restore(),this.ctx.beginPath(),this.ctx.arc(s,a,i,0,Math.PI*2),this.ctx.strokeStyle="rgba(0, 0, 0, 0.1)",this.ctx.lineWidth=1,this.ctx.stroke()):this.drawGradientCoin(e,s,a,i)}drawGradientCoin(e,t,s,a){this.ctx.beginPath();const i=this.ctx.createRadialGradient(t-a*.2,s-a*.2,a*.1,t,s,a);i.addColorStop(0,e.highlight||e.color),i.addColorStop(1,e.color),this.ctx.fillStyle=i,this.ctx.arc(t,s,a,0,Math.PI*2),this.ctx.fill()}drawAimingLine(e,t,s){const a=this.canvas.width,i=e.x*a,r=e.y*a,n=i-(s.x-t.x),o=r-(s.y-t.y),l=n-i,d=o-r,c=Math.sqrt(l*l+d*d);if(c<5)return;const u=a*.3,h=Math.min(c/u,1);let p,v;h<.33?(p="rgba(74, 222, 128, 0.9)",v="rgba(74, 222, 128, 0.3)"):h<.66?(p="rgba(251, 191, 36, 0.9)",v="rgba(251, 191, 36, 0.3)"):(p="rgba(239, 68, 68, 0.9)",v="rgba(239, 68, 68, 0.3)"),this.ctx.save(),this.ctx.shadowColor=v,this.ctx.shadowBlur=15;const f=this.ctx.createLinearGradient(i,r,n,o);f.addColorStop(0,"rgba(255, 255, 255, 0.3)"),f.addColorStop(1,p),this.ctx.beginPath(),this.ctx.moveTo(i,r),this.ctx.lineTo(n,o),this.ctx.strokeStyle=f,this.ctx.lineWidth=5,this.ctx.lineCap="round",this.ctx.stroke(),this.ctx.setLineDash([10,10]),this.ctx.strokeStyle="rgba(255, 255, 255, 0.4)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(i,r),this.ctx.lineTo(n,o),this.ctx.stroke(),this.ctx.setLineDash([]);const y=Math.atan2(d,l),T=15;this.ctx.beginPath(),this.ctx.moveTo(n,o),this.ctx.lineTo(n-T*Math.cos(y-Math.PI/6),o-T*Math.sin(y-Math.PI/6)),this.ctx.lineTo(n-T*Math.cos(y+Math.PI/6),o-T*Math.sin(y+Math.PI/6)),this.ctx.closePath(),this.ctx.fillStyle=p,this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(n,o,8,0,Math.PI*2),this.ctx.fillStyle=p,this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=2,this.ctx.stroke();const I=Math.round(h*100);this.ctx.font="bold 14px Inter, sans-serif",this.ctx.fillStyle="white",this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=3,this.ctx.textAlign="center",this.ctx.textBaseline="middle";const x=i+l*.5,M=r+d*.5-15;this.ctx.strokeText(`${I}%`,x,M),this.ctx.fillText(`${I}%`,x,M),this.ctx.restore()}loadCoinImages(e){let t=0;const s=this.imagePaths.length;if(this.coinImages=[],s===0){e&&e();return}const a=()=>{t++,t===s&&e&&e()};this.imagePaths.forEach(i=>{const r=new Image;r.onload=a,r.onerror=()=>{console.error(`Failed to load coin image: ${i}`),a()},r.src=i,this.coinImages.push(r)})}assignRandomCoinImages(e){if(this.coinImageAssignments={},!this.coinImages||this.coinImages.length===0)return;const t=[...this.coinImages].sort(()=>.5-Math.random());e.forEach((s,a)=>{this.coinImageAssignments[s.id]=t[a%t.length]})}resizeCanvas(e){const s=this.container.getBoundingClientRect().width,a=s*(this.LOGICAL_HEIGHT/this.LOGICAL_WIDTH);this.canvas.width=s,this.canvas.height=a,e&&e()}loadWoodTexture(e){const t=new Image;t.src="https://www.transparenttextures.com/patterns/wood-pattern.png",t.onload=()=>{this.woodPattern=this.ctx.createPattern(t,"repeat"),e&&e()}}}class ne{constructor(e,t,s,a){this.canvas=e,this.gameManager=t,this.auth=s,this.database=a,this.boundHandleStart=null,this.boundHandleMove=null,this.boundHandleEnd=null}getMousePos(e){const t=this.canvas.getBoundingClientRect(),s=e.clientX||e.touches&&e.touches[0].clientX,a=e.clientY||e.touches&&e.touches[0].clientY;return{x:s-t.left,y:a-t.top}}handleStart(e){var n;const t=this.gameManager;if(t.gameState!=="playing"||t.physicsTimer||!(((n=t.players[t.currentPlayerIndex])==null?void 0:n.uid)===this.auth.currentUser.uid))return;const a=this.getMousePos(e),i=this.canvas.width,r=t.COIN_DIAMETER_RATIO/2*i;for(const o of t.coins){const l=o.x*i,d=o.y*i,c=l-a.x,u=d-a.y;if(Math.sqrt(c*c+u*u)<r){if((t.rules?t.rules.sameCoinFoul:!0)&&o.id===t.lastMovedCoinId){const p=document.getElementById("game-container");if(!p)return;const v=document.createElement("div");v.textContent="Aynƒ± parayla √ºst √ºste oynayamazsƒ±n!",v.className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-800/90 text-white p-4 rounded-lg text-2xl z-50 pointer-events-none",p.appendChild(v),setTimeout(()=>v.remove(),1500);return}t.selectedCoin=o,t.isDragging=!0,t.dragStart=a,t.dragEnd=a,navigator.vibrate&&navigator.vibrate(10),e.preventDefault(),document.body.classList.add("scrolling-disabled");break}}}handleMove(e){const t=this.gameManager;t.isDragging&&(e.preventDefault(),t.dragEnd=this.getMousePos(e),t.draw())}handleEnd(e){const t=this.gameManager;if(!t.isDragging||!t.selectedCoin)return;document.body.classList.remove("scrolling-disabled"),t.isDragging=!1;const s={x:t.dragEnd.x-t.dragStart.x,y:t.dragEnd.y-t.dragStart.y};if(Math.sqrt(s.x**2+s.y**2)<10){t.selectedCoin=null,t.draw();return}if(navigator.vibrate){const n=Math.sqrt(s.x**2+s.y**2),o=Math.min(Math.floor(n/2),50);navigator.vibrate(o)}const a=-s.x/this.canvas.width*.125,i=-s.y/this.canvas.width*.125,r={coinId:t.selectedCoin.id,vx:a,vy:i,madeBy:this.auth.currentUser.uid};if(window.practiceMode&&window.practiceMode.active){const n={players:t.players,coins:t.coins,currentPlayerIndex:t.currentPlayerIndex,status:t.gameState,lastMovedCoinId:t.lastMovedCoinId,isPathFoulActive:t.isPathFoulActive,collisionOccurredDuringSim:!1,hostUid:t.hostUid,rules:t.rules};window.practiceMode.pendingFlick={flickData:r,currentState:n},document.dispatchEvent(new CustomEvent("practiceFlickReady"))}else this.database.ref(`games/${window.currentGameId}/activeFlick`).set(r);t.selectedCoin=null,t.draw()}init(){this.boundHandleStart=e=>this.handleStart(e),this.boundHandleMove=e=>this.handleMove(e),this.boundHandleEnd=e=>this.handleEnd(e),this.canvas.addEventListener("mousedown",this.boundHandleStart),this.canvas.addEventListener("mousemove",this.boundHandleMove),this.canvas.addEventListener("mouseup",this.boundHandleEnd),this.canvas.addEventListener("mouseleave",this.boundHandleEnd),this.canvas.addEventListener("touchstart",this.boundHandleStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.boundHandleMove,{passive:!1}),this.canvas.addEventListener("touchend",this.boundHandleEnd)}cleanup(){this.boundHandleStart&&(this.canvas.removeEventListener("mousedown",this.boundHandleStart),this.canvas.removeEventListener("mousemove",this.boundHandleMove),this.canvas.removeEventListener("mouseup",this.boundHandleEnd),this.canvas.removeEventListener("mouseleave",this.boundHandleEnd),this.canvas.removeEventListener("touchstart",this.boundHandleStart),this.canvas.removeEventListener("touchmove",this.boundHandleMove),this.canvas.removeEventListener("touchend",this.boundHandleEnd))}}class X{constructor(e){this.LOGICAL_WIDTH=e.LOGICAL_WIDTH,this.LOGICAL_HEIGHT=e.LOGICAL_HEIGHT,this.COIN_DIAMETER_RATIO=e.COIN_DIAMETER_RATIO,this.GOAL_WIDTH_RATIO=e.GOAL_WIDTH_RATIO,this.LOGICAL_HEIGHT_RATIO=this.LOGICAL_HEIGHT/this.LOGICAL_WIDTH,this.COIN_RADIUS=this.COIN_DIAMETER_RATIO/2,this.GOAL_WIDTH=this.GOAL_WIDTH_RATIO,this.GOAL_X=.5-this.GOAL_WIDTH/2,this.GOAL_DEPTH=this.COIN_RADIUS*3,this.FRICTION=.985,this.ANGULAR_FRICTION=.97,this.START_Y=this.LOGICAL_HEIGHT_RATIO-this.LOGICAL_HEIGHT_RATIO*.1}update(e,t,s=!1){let a=!1,i=!1,r=!1,n=!1;for(const o of e)o.rotationZ===void 0&&(o.rotationZ=0),o.v_rotationZ===void 0&&(o.v_rotationZ=0),o.x+=o.vx,o.y+=o.vy,o.vx*=this.FRICTION,o.vy*=this.FRICTION,o.v_rotationZ*=this.ANGULAR_FRICTION,o.rotationZ=(o.rotationZ+o.v_rotationZ)%(2*Math.PI),Math.sqrt(o.vx**2+o.vy**2)>.001||Math.abs(o.v_rotationZ)>1e-4?a=!0:(o.vx=0,o.vy=0,o.v_rotationZ=0),this.checkFallFoul(o)?(n=!0,t.fallFoulTriggered=!0,o.vx=0,o.vy=0):this.checkWallCollisions(o),t.goalScoredThisTurn||o.y<=0&&o.x>=this.GOAL_X&&o.x<=this.GOAL_X+this.GOAL_WIDTH&&(r=!0,t.goalScoredThisTurn=!0,o.vx=0,o.vy=0,o.y<-this.GOAL_DEPTH&&(o.y=-this.GOAL_DEPTH));return this.checkCoinCollisions(e,s)&&(i=!0),{isMoving:a,collisionDetected:i,goalScored:r,foulTriggered:n}}checkFallFoul(e){return e.x<0||e.x>1||e.y>this.LOGICAL_HEIGHT_RATIO||e.y<0&&(e.x<this.GOAL_X||e.x>this.GOAL_X+this.GOAL_WIDTH)}checkWallCollisions(e){let t=!1;return e.y<-this.GOAL_DEPTH&&(e.y=-this.GOAL_DEPTH,e.vy=0,e.vx=0,t=!0),t}checkCoinCollisions(e,t=!1){let s=!1;for(let a=0;a<e.length;a++)for(let i=a+1;i<e.length;i++){const r=e[a],n=e[i],o=n.x-r.x,l=n.y-r.y,d=Math.sqrt(o*o+l*l),c=this.COIN_RADIUS*2;if(d<c&&(s=!0,t)){const u=c-d,h=o/d*u/2,p=l/d*u/2;r.x-=h,r.y-=p,n.x+=h,n.y+=p;const v=o/d,f=l/d,y=-f,T=v,I=v*r.vx+f*r.vy;y*r.vx+T*r.vy;const x=v*n.vx+f*n.vy;y*n.vx+T*n.vy;const M=I-x;if(M>0){const P=-1.9*M/2,A=P*v,R=P*f;r.vx+=A,r.vy+=R,n.vx-=A,n.vy-=R}}}return s}static checkPathIntersection(e,t,s,a){e.x+t.x,e.y+t.y,(s.x+a.x)/2,(s.y+a.y)/2;const i=t.x,r=t.y,n=a.x-s.x,o=a.y-s.y,l=i*o-r*n;if(Math.abs(l)<1e-4)return!1;const d=s.x-e.x,c=s.y-e.y,u=(d*o-c*n)/l,h=(d*r-c*i)/l;return u>=0&&u<=1&&h>=0&&h<=1}simulateFlick(e,t,s){let a=JSON.parse(JSON.stringify(t));a.status="simulating",a.collisionOccurredDuringSim=!1,a.goalScoredThisTurn=!1,a.fallFoulTriggered=!1;const i=a.coins.find(f=>f.id===e.coinId);if(!i)return{event:"error",finalCoins:a.coins};const r={x:i.x,y:i.y},n=Math.abs(i.y-this.START_Y)<.001;i.vx=e.vx,i.vy=e.vy,i.movedThisTurn=!0;const o=Math.sqrt(e.vx**2+e.vy**2),l=o*.05,d=Math.random()*.2-.1;i.v_rotationZ=l*(1+d),i.v_rotationZ===0&&o>0&&(i.v_rotationZ=.01);let c=0;const u=1e3/60,h=5e3;for(;c<h;){const f=this.update(a.coins,a,!s.collisionFoul);if(f.collisionDetected&&s.collisionFoul)return{event:"collision_foul",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:!0,simulationTime:c};if(f.foulTriggered&&s.fallFoul)return{event:"fall_foul",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:a.collisionOccurredDuringSim,simulationTime:c};if(!f.isMoving)break;c+=u}let p=[],v=a.goalScoredThisTurn;if(v&&a.coins.some(f=>!f.movedThisTurn)&&(p.push("T√ºm paralar oynanmadan gol atƒ±lamaz"),v=!1),v&&s.directGoalFoul&&n&&(p.push("Ba≈ülangƒ±√ßtan direkt gol atƒ±lamaz"),v=!1),v)return{event:"goal",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:a.collisionOccurredDuringSim,simulationTime:c};if(s.collisionFoul&&a.collisionOccurredDuringSim)return{event:"collision_foul",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:!0,simulationTime:c};if(s.pathFoul&&a.isPathFoulActive){const f=a.coins.find(T=>T.id===e.coinId),y=a.coins.filter(T=>T.id!==e.coinId);if(f&&y.length===2){const T={x:f.x-r.x,y:f.y-r.y};if(Math.sqrt(T.x**2+T.y**2)>.001&&!X.checkPathIntersection(r,T,y[0],y[1]))return{event:"path_foul",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:a.collisionOccurredDuringSim,simulationTime:c}}}return p.includes("Ba≈ülangƒ±√ßtan direkt gol atƒ±lamaz")?{event:"direct_goal_foul",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:a.collisionOccurredDuringSim,simulationTime:c}:{event:"clean",finalCoins:a.coins,movedCoinId:e.coinId,collisionOccurred:a.collisionOccurredDuringSim,simulationTime:c}}}class re{constructor(e){this.database=e,this.userStats={wins:0,draws:0,losses:0,totalGames:0,weeklyGames:0,totalPoints:0,weeklyPoints:0,level:1,xp:650,xpForNextLevel:1e3,rank:"ü•â Bronz Lig"}}getLeagueInfo(e){return e>=1e3?{name:"Elmas Lig",tier:4,minPoints:1e3,maxPoints:999999,icon:"üíé",color:"purple"}:e>=500?{name:"Altƒ±n Lig",tier:3,minPoints:500,maxPoints:999,icon:"üëë",color:"yellow"}:e>=200?{name:"G√ºm√º≈ü Lig",tier:2,minPoints:200,maxPoints:499,icon:"ü•à",color:"gray"}:{name:"Bronz Lig",tier:1,minPoints:0,maxPoints:199,icon:"ü•â",color:"orange"}}loadUserStats(){const e=localStorage.getItem("coinmatch_user_stats");e&&(this.userStats={...this.userStats,...JSON.parse(e)}),this.userStats.totalGames=this.userStats.wins+this.userStats.losses+this.userStats.draws,this.userStats.winRate=this.userStats.totalGames>0?Math.round(this.userStats.wins/this.userStats.totalGames*100):0}async loadStatsFromDB(e){if(e)try{const a=(await this.database.ref(`users/${e}/stats`).once("value")).val();a&&(this.userStats={...this.userStats,...a},this.saveUserStats())}catch(t){console.error("Error loading user stats from DB:",t)}}saveUserStats(){localStorage.setItem("coinmatch_user_stats",JSON.stringify(this.userStats))}updateDashboard(){this.loadUserStats();const e=document.getElementById("user-welcome"),t=document.getElementById("user-level"),s=document.getElementById("user-rank"),a=document.getElementById("xp-progress"),i=document.getElementById("xp-text-label");if(e&&window.currentUser){const d=window.currentUser.displayName||"Oyuncu";e.textContent=`Ho≈ü geldin, ${d}!`}if(t&&(t.textContent=`Level ${this.userStats.level}`),s&&(s.textContent=this.userStats.rank),a){const d=this.userStats.xp/this.userStats.xpForNextLevel*100;a.style.width=`${d}%`,a.classList.add("xp-progress-animated")}i&&(i.textContent=`${this.userStats.xp} / ${this.userStats.xpForNextLevel} XP`),this.animateNumber("wins-count",this.userStats.wins),this.animateNumber("losses-count",this.userStats.losses),this.animateNumber("total-games",this.userStats.totalGames),this.animateNumber("total-points",this.userStats.totalPoints);const r=document.getElementById("win-rate");r&&(r.textContent=`${this.userStats.winRate}% oran`);const n=document.getElementById("loss-rate");if(n){const d=this.userStats.totalGames>0?Math.round(this.userStats.losses/this.userStats.totalGames*100):0;n.textContent=`${d}% oran`}const o=document.getElementById("weekly-games");o&&(o.textContent=this.userStats.weeklyGames);const l=document.getElementById("weekly-points");l&&(l.textContent=this.userStats.weeklyPoints),this.updateAvatar(),this.applyCardAnimations()}animateNumber(e,t,s=1e3){const a=document.getElementById(e);if(!a)return;const i=0,r=t/(s/16);let n=i;const o=setInterval(()=>{n+=r,n>=t&&(n=t,clearInterval(o)),a.textContent=Math.floor(n),a.classList.add("stat-number")},16)}updateAvatar(){var t;const e=document.getElementById("user-avatar");if(e&&window.currentUser&&window.currentUser.photoURL)e.innerHTML=`<img src="${window.currentUser.photoURL}" class="w-full h-full rounded-full object-cover" alt="Avatar">`;else if(e){const a=(((t=window.currentUser)==null?void 0:t.displayName)||"U").split(" ").map(i=>i[0]).join("").toUpperCase();e.textContent=a}}applyCardAnimations(){document.querySelectorAll(".dashboard-card, .bg-slate-800\\/80").forEach((t,s)=>{t.style.animationDelay=`${s*.1}s`,t.classList.add("dashboard-card")})}addXP(e){for(this.userStats.xp+=e;this.userStats.xp>=this.userStats.xpForNextLevel;)this.userStats.xp-=this.userStats.xpForNextLevel,this.userStats.level++,this.userStats.xpForNextLevel=Math.floor(this.userStats.xpForNextLevel*1.2),this.showLevelUpNotification();this.saveUserStats(),this.updateDashboard()}showLevelUpNotification(){const e=document.createElement("div");e.className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 px-6 py-3 rounded-lg shadow-xl z-50 font-bold",e.innerHTML=`üéâ Level ${this.userStats.level} Atladƒ±n! üéâ`,document.body.appendChild(e),e.style.opacity="0",e.style.transform="translate(-50%, -100%)",setTimeout(()=>{e.style.transition="all 0.5s ease-out",e.style.opacity="1",e.style.transform="translate(-50%, 0)"},100),setTimeout(()=>{e.style.opacity="0",e.style.transform="translate(-50%, -100%)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},500)},3e3)}recordGameResult(e,t="online"){let s=0;if(t==="online"||t==="multiplayer"){let a=0;e==="win"?(this.userStats.wins++,s=3,a=5,this.userStats.totalPoints+=s,this.userStats.weeklyPoints+=s):e==="draw"?(this.userStats.draws++,s=1,a=3,this.userStats.totalPoints+=s,this.userStats.weeklyPoints+=s):e==="loss"&&(this.userStats.losses++,s=0,a=1),this.addXP(a),this.userStats.totalGames++,this.userStats.weeklyGames++}return this.userStats.winRate=this.userStats.totalGames>0?Math.round(this.userStats.wins/this.userStats.totalGames*100):0,this.saveUserStats(),this.updateDashboard(),this.updateLeaderboard(),s}async updateLeaderboard(){const e=document.getElementById("leaderboard-table"),t=document.getElementById("leaderboard-league-badge");if(e)try{const s=this.getLeagueInfo(this.userStats.totalPoints);t&&(t.textContent=`${s.icon} ${s.name} Puan Tablosu`,t.className="text-xl font-bold",s.tier===4?t.classList.add("text-purple-400"):s.tier===3?t.classList.add("text-yellow-400"):s.tier===2?t.classList.add("text-gray-300"):t.classList.add("text-orange-400"));const r=(await this.database.ref("users").once("value")).val();if(!r){e.innerHTML=`
                    <tr>
                        <td colspan="7" class="py-4 text-center text-slate-500">
                            Hen√ºz kayƒ±tlƒ± oyuncu yok
                        </td>
                    </tr>
                `;return}const n=[];for(const[l,d]of Object.entries(r)){const c=d.stats||{},u=d.profile||{},h=c.wins||0,p=c.draws||0,v=c.losses||0,f=h+p+v,y=c.totalPoints||0;if(this.getLeagueInfo(y).name!==s.name)continue;const I=u.nickname||u.firstname||"Oyuncu";n.push({uid:l,displayName:I,totalGames:f,wins:h,draws:p,losses:v,totalPoints:y})}if(n.length===0){e.innerHTML=`
                    <tr>
                        <td colspan="7" class="py-4 text-center text-slate-400">
                            <div class="flex flex-col items-center space-y-2">
                                <span class="text-3xl">üèÜ</span>
                                <span>Bu ligde hen√ºz ba≈üka oyuncu yok</span>
                                <span class="text-xs text-slate-500">ƒ∞lk sƒ±radasƒ±n! üéâ</span>
                            </div>
                        </td>
                    </tr>
                `;return}n.sort((l,d)=>d.totalPoints!==l.totalPoints?d.totalPoints-l.totalPoints:d.wins-l.wins);let o="";n.forEach((l,d)=>{const c=d+1,u=window.currentUser&&l.uid===window.currentUser.uid,h=u?"border-b border-slate-700/50 bg-amber-500/10 hover:bg-amber-500/20":"border-b border-slate-700/50 hover:bg-slate-700/30",p=c,v=u?"üë§":"üéÆ",f=u?`${l.displayName} (Sen)`:l.displayName,y=u?` (${c}. sƒ±ra)`:"";o+=`
                    <tr class="${h}">
                        <td class="py-3 px-2 font-bold ${c<=3?"text-amber-400":"text-slate-400"}">${p}</td>
                        <td class="py-3 px-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${v}</span>
                                <span class="${u?"font-bold text-amber-300":""}">${f}${y}</span>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-center">${l.totalGames}</td>
                        <td class="py-3 px-2 text-center text-green-400">${l.wins}</td>
                        <td class="py-3 px-2 text-center text-yellow-400">${l.draws}</td>
                        <td class="py-3 px-2 text-center text-red-400">${l.losses}</td>
                        <td class="py-3 px-2 text-center font-bold text-amber-400">${l.totalPoints}</td>
                    </tr>
                `}),e.innerHTML=o}catch(s){console.error("Error loading leaderboard:",s),e.innerHTML=`
                <tr>
                    <td colspan="7" class="py-4 text-center text-red-400">
                        Puan tablosu y√ºklenirken hata olu≈ütu
                    </td>
                </tr>
            `}}init(){this.updateDashboard(),this.updateLeaderboard()}}class oe{constructor(e,t,s,a,i,r,n,o){this.auth=e,this.database=t,this.showScreen=s,this.getUserDisplayName=a,this.showToast=i,this.showConfirm=r,this.calculateUserRank=n,this.formatTime=o,this.currentGameId=null,this.listeners={game:null,gameState:null,activeFlick:null,ack:null,gameStatus:null,rematch:null},this.presenceListeners={},this.presenceInitialized={},this.gameStartTime={},this.lastGameStateUpdate={},this.lobbyAlertShown=!1,this.autoStartTriggered=!1,this.pendingGameType=null}async generateGameCode(e=6){let t,s=0;const a=10;for(;s<a;){if(t=Array.from({length:e},()=>"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(Math.random()*36))).join(""),!(await this.database.ref(`games/${t}`).once("value")).exists())return t;s++}const i=Date.now().toString(36).toUpperCase().slice(-4);return t=t.slice(0,-4)+i,t}async createPublicGame(e={}){const t=await this.generateGameCode(),s=this.auth.currentUser,a=await this.getUserDisplayName(s),r=(await this.database.ref(`users/${s.uid}/stats`).once("value")).val()||{totalPoints:0},n=this.calculateUserRank(r.totalPoints),o=this.database.ref(`games/${t}`),l={host:s.uid,type:"public",league:n.tier,leagueName:n.name,status:"lobby",createdAt:firebase.database.ServerValue.TIMESTAMP,rules:e,players:{[s.uid]:{email:s.email,displayName:a,ready:!1}}};await o.set(l),this.enterLobby(t)}async createPrivateGame(e={}){const t=await this.generateGameCode(),s=this.auth.currentUser,a=await this.getUserDisplayName(s),i=this.database.ref(`games/${t}`),r={host:s.uid,type:"private",status:"lobby",createdAt:firebase.database.ServerValue.TIMESTAMP,rules:e,players:{[s.uid]:{email:s.email,displayName:a,ready:!1}}};await i.set(r),this.enterLobby(t)}async joinGame(e){if(!e)return;const t=e.toUpperCase(),a=await this.database.ref(`games/${t}`).once("value");if(a.exists()&&a.val().status==="lobby"){const i=a.val(),r=this.auth.currentUser;if(i.type==="public"&&i.league){const l=(await this.database.ref(`users/${r.uid}/stats`).once("value")).val()||{totalPoints:0},d=this.calculateUserRank(l.totalPoints);if(d.tier!==i.league){this.showToast(`Bu oyun ${i.leagueName} ligine √∂zel. Sizin liginiz: ${d.name}`,"error",4e3);return}}const n=await this.getUserDisplayName(r);await this.database.ref(`games/${t}/players/${r.uid}`).set({email:r.email,displayName:n,ready:!1}),this.enterLobby(t)}else this.showToast("Oyun bulunamadƒ± veya √ßoktan ba≈ülamƒ±≈ü.","error",3e3)}async loadAvailableGames(e={}){var v;const t=this.auth.currentUser,a=(await this.database.ref(`users/${t.uid}/stats`).once("value")).val()||{totalPoints:0},i=this.calculateUserRank(a.totalPoints),r=document.getElementById("available-games-user-league");r&&(r.textContent=i.name);const o=(await this.database.ref("games").once("value")).val()||{},d=(await this.database.ref("users").orderByChild("stats").once("value")).val()||{},c=document.getElementById("available-games-list");if(!c)return;let u=[];for(const[f,y]of Object.entries(o)){const T=y.players?Object.keys(y.players).length:0;if(y.type==="public"&&y.status==="lobby"&&y.league===i.tier&&y.host!==t.uid&&T>0){const I=((v=d[y.host])==null?void 0:v.stats)||{totalGamesPlayed:0,totalFouls:0},x=I.totalGamesPlayed>5?I.totalFouls/I.totalGamesPlayed:-1;u.push({code:f,...y,foulRate:x})}}const h=u.filter(f=>{const y=f.rules||{},T=y.collisionFoul!==!1,I=y.sameCoinFoul!==!1;return!(e.collisionFoul==="on"&&!T||e.collisionFoul==="off"&&T||e.sameCoinFoul==="on"&&!I||e.sameCoinFoul==="off"&&I)});h.sort((f,y)=>{const T=f.rules||{},I=y.rules||{};if(e.sortLives&&e.sortLives!=="none"){const x=T.initialLives||3,M=I.initialLives||3;if(x!==M)return e.sortLives==="asc"?x-M:M-x}if(e.sortMinMoves&&e.sortMinMoves!=="none"){const x=T.minMoves||3,M=I.minMoves||3;if(x!==M)return e.sortMinMoves==="asc"?x-M:M-x}if(e.sortFoulRate==="asc"){const x=f.foulRate===-1?999:f.foulRate,M=y.foulRate===-1?999:y.foulRate;if(x!==M)return x-M}return(y.createdAt||0)-(f.createdAt||0)});let p=`
            <div class="bg-gradient-to-br from-amber-500/20 to-amber-600/20 p-6 rounded-xl border-2 border-amber-500/50 text-center mb-4">
                 <div class="text-4xl mb-3">üéÆ</div>
                 <p class="text-white font-bold text-lg mb-2">Yeni Oyun Olu≈ütur</p>
                 <p class="text-slate-300 text-sm mb-4">Kendi oyununu ba≈ülat, diƒüer oyuncular katƒ±lsƒ±n</p>
                 <button id="create-game-from-list" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 hover:scale-105 shadow-lg">
                     <span class="flex items-center justify-center gap-2">
                         ‚ûï Yeni Oyun Olu≈ütur
                     </span>
                 </button>
             </div>
        `;h.length===0?p+=`
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">ü§∑‚Äç‚ôÄÔ∏è</div>
                    <p class="text-slate-400 text-lg">Filtrelerinize uygun oyun bulunamadƒ±</p>
                    <p class="text-slate-500 text-sm mt-2">Filtreleri sƒ±fƒ±rlamayƒ± veya yeni bir oyun olu≈üturmayƒ± deneyin.</p>
                </div>
            `:p+=h.map(f=>{var B,C;const y=f.players?Object.keys(f.players).length:0,T=f.players&&f.players[f.host]?f.players[f.host].displayName:"Oyuncu",I=f.rules||{},x=I.collisionFoul!==!1,M=I.sameCoinFoul!==!1,P=I.initialLives||3,A=I.minMoves||3,R=f.foulRate===-1?"N/A":`${(f.foulRate*100).toFixed(0)}%`;return`
                    <div class="game-card bg-gradient-to-br from-slate-800/80 to-slate-900/80 p-5 rounded-xl border-2 border-slate-600/50 hover:border-amber-500/50 transition-all duration-200 hover:scale-[1.02] cursor-pointer" data-game-code="${f.code}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center text-white font-bold text-lg">
                                    ${T.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p class="text-white font-bold">${T}</p>
                                    <p class="text-slate-400 text-sm">${f.leagueName}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-slate-400 text-sm">Kod:</p>
                                <p class="text-amber-400 font-bold text-lg">${f.code}</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 mb-4 bg-slate-900/50 p-2 rounded-lg">
                            <div class="flex items-center gap-1 text-xs text-slate-300" title="Can Sayƒ±sƒ±">
                                <span>‚ù§Ô∏è</span>
                                <span class="font-bold">${P}</span>
                            </div>
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                            <div class="flex items-center gap-1 text-xs text-slate-300" title="Min. Hamle">
                                <span>üéØ</span>
                                <span class="font-bold">${A}</span>
                            </div>
                            ${(C=(B=f.rules)==null?void 0:B.timeRule)!=null&&C.enabled?`
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                            <div class="flex items-center gap-1 text-xs text-slate-300" title="S√ºre Limiti">
                                <span>‚è±Ô∏è</span>
                                <span class="font-bold">${f.rules.timeRule.timeLimitMinutes||5} dk</span>
                            </div>`:""}
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                            <div class="flex items-center gap-1 text-xs" title="√áarpƒ±≈üma Faul√º">
                                <span>üí•</span>
                                ${x?'<span class="text-red-400 font-bold">A√ßƒ±k</span>':'<span class="text-green-400 font-bold">Kapalƒ±</span>'}
                            </div>
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                             <div class="flex items-center gap-1 text-xs" title="√úst √úste Oynama Faul√º">
                                 <span>üîÑ</span>
                                 ${M?'<span class="text-red-400 font-bold">A√ßƒ±k</span>':'<span class="text-green-400 font-bold">Kapalƒ±</span>'}
                             </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 text-slate-300">
                                <div class="flex items-center gap-1 text-xs" title="Ev Sahibi Faul Oranƒ±">
                                    <span>üö´</span>
                                    <span>${R}</span>
                                </div>
                                <div class="w-px h-4 bg-slate-700"></div>
                                <div class="flex items-center gap-1 text-xs">
                                     <span>üë•</span>
                                     <span>${y}/2 Oyuncu</span>
                                </div>
                             </div>
                             <button class="join-game-btn bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold py-2 px-5 rounded-lg transition-all duration-200 hover:scale-105">
                                Katƒ±l
                             </button>
                        </div>
                    </div>
                `}).join(""),c.innerHTML=p,this.addGameCardListeners()}addGameCardListeners(){var e;(e=document.getElementById("create-game-from-list"))==null||e.addEventListener("click",()=>{this.pendingGameType="public",this.showScreen("createGameSettings")}),document.querySelectorAll(".game-card").forEach(t=>{t.addEventListener("click",s=>{if(s.target.classList.contains("join-game-btn"))return;const a=t.getAttribute("data-game-code");this.joinGame(a)})}),document.querySelectorAll(".join-game-btn").forEach(t=>{t.addEventListener("click",s=>{s.stopPropagation();const i=s.target.closest(".game-card").getAttribute("data-game-code");this.joinGame(i)})})}enterLobby(e){this.currentGameId=e,window.currentGameId=e,this.showScreen("lobby");const t=this.database.ref(`games/${this.currentGameId}`);this.listeners.game&&t.off("value",this.listeners.game),this.lobbyAlertShown=!1,this.autoStartTriggered=!1,this.database.ref(`games/${this.currentGameId}/players/${this.auth.currentUser.uid}`).onDisconnect().remove(),this.gameStateManager&&this.gameStateManager.listenForCoinToss(this.currentGameId),this.listeners.game=t.on("value",a=>{const i=a.val();if(!i){this.showScreen("mainMenu"),this.showToast("Oyun sonlandƒ±rƒ±ldƒ±.","info",3e3);return}const r=this.auth.currentUser;if(!i.players||!i.players[r.uid]){if(this.lobbyAlertShown)return;this.lobbyAlertShown=!0,this.showToast("Lobiden √ßƒ±karƒ±ldƒ±nƒ±z.","warning",3e3),this.showScreen("mainMenu");return}if(i.status==="in-progress"||i.status==="playing"){this.showScreen("game"),window.chatManager.setupListener(this.currentGameId),window.gameManager&&(window.gameManager.resizeCanvas(),window.gameManager.updateState(i.gameState)),this.listeners.game&&t.off("value",this.listeners.game),this.gameStateManager&&this.gameStateManager.listenToGameState(this.currentGameId),this.setupRematchListener(this.currentGameId);return}this.updateLobbyUI(i),i.players&&Object.keys(i.players).length>1})}updateLobbyUI(e){const t=this.auth.currentUser,s=document.getElementById("lobby-game-code"),a=document.getElementById("lobby-player-list"),i=document.getElementById("lobby-league-info"),r=document.getElementById("ready-button"),n=document.getElementById("start-game-from-lobby-button");s&&(s.textContent=this.currentGameId),i&&e.leagueName&&(i.textContent=`üéØ ${e.leagueName}`);const o=e.rules||{collisionFoul:!0,sameCoinFoul:!0,initialLives:3,minMoves:3},l=document.getElementById("rule-collision-icon"),d=document.getElementById("rule-same-coin-icon"),c=document.getElementById("rule-lives-count"),u=document.getElementById("rule-min-moves-count"),h=document.getElementById("rule-time-container"),p=document.getElementById("rule-time-limit");if(l&&(l.textContent=o.collisionFoul?"‚úÖ":"‚ùå"),d&&(d.textContent=o.sameCoinFoul?"‚úÖ":"‚ùå"),c&&(c.textContent=o.initialLives||3),u&&(u.textContent=o.minMoves||3),h&&p&&(o.timeRule&&o.timeRule.enabled?(h.classList.remove("hidden"),p.textContent=`${o.timeRule.timeLimitMinutes||5} dk`):h.classList.add("hidden")),!a)return;a.innerHTML="";let v=!0;if(!e.players)return;Object.entries(e.players).forEach(([I,x])=>{const M=I===e.host,P=String.fromCodePoint(128421,65039),A=String.fromCodePoint(128100),R=M?`<span class="ml-2 inline-flex items-center text-blue-400" title="Host">${P}</span>`:`<span class="ml-2 inline-flex items-center text-slate-300/80" title="Client">${A}</span>`,B=x.ready?'<span class="text-green-400">‚úì Hazƒ±r</span>':'<span class="text-slate-400">Bekliyor...</span>';x.ready||(v=!1);const C=document.createElement("div");C.className="bg-slate-700/50 p-4 rounded-lg",C.innerHTML=`
                <div class="flex items-center justify-between">
                    <span class="font-semibold">${x.displayName}${R}</span>
                    ${B}
                </div>
            `,a.appendChild(C)});const f=e.players[t.uid];if(r&&f){f.ready?(r.textContent="Hazƒ±rƒ±m ‚úì",r.classList.remove("bg-amber-500","hover:bg-amber-600"),r.classList.add("bg-green-500","hover:bg-green-600")):(r.textContent="Hazƒ±rƒ±m",r.classList.remove("bg-green-500","hover:bg-green-600"),r.classList.add("bg-amber-500","hover:bg-amber-600")),r.replaceWith(r.cloneNode(!0));const I=document.getElementById("ready-button");I&&I.addEventListener("click",()=>{this.toggleReady()})}const y=t.uid===e.host,T=Object.keys(e.players).length;n&&(y&&v&&T>=2?n.classList.remove("hidden"):n.classList.add("hidden")),y&&v&&T>=2&&!this.autoStartTriggered&&(this.autoStartTriggered=!0,setTimeout(()=>{this.database.ref(`games/${this.currentGameId}`).once("value",x=>{const M=x.val();M&&M.status==="lobby"&&M.host===t.uid&&this.startGameWithToss()})},1500))}async startGameWithToss(){const e=this.database.ref(`games/${this.currentGameId}`),s=(await e.once("value")).val();if(!s||s.host!==this.auth.currentUser.uid){console.error("Only the host can start the game.");return}if(Object.values(s.players).length===2){const i=e.child("coinToss");try{const r={},n=Object.keys(s.players),o=Math.random()<.5;r[n[0]]=o?"Yazƒ±":"Tura",r[n[1]]=o?"Tura":"Yazƒ±",await i.set({status:"starting",choices:r}),await this._sleep(500);const l=Math.floor(Math.random()*2),d=n[l];await i.update({status:"flipping",winnerUid:d}),await this._sleep(3e3),await i.update({status:"finished"}),await this._sleep(2e3),await this._initializeGame(e,s,d)}catch(r){console.error("Coin toss failed, starting game normally.",r),await this._initializeGame(e,s)}finally{await i.remove()}}else await this._initializeGame(e,s)}async _initializeGame(e,t,s=null){var T,I,x,M;const a=this.auth.currentUser;if(t.host!==a.uid){console.error("Only host can start the game");return}if(!Object.values(t.players).every(P=>P.ready)){this.showToast("T√ºm oyuncular hazƒ±r deƒüil!","error",3e3);return}const r=window.gameManager.LOGICAL_HEIGHT/window.gameManager.LOGICAL_WIDTH,n=window.gameManager.COIN_DIAMETER_RATIO,o=r-r*.1,l=n/2,d=[{id:0,x:.5,y:o,vx:0,vy:0,color:"#c0c0c0",highlight:"#f0f0f0",inGoal:!1,movedThisTurn:!1,rotationZ:Math.random()*2*Math.PI,v_rotationZ:0},{id:1,x:.5-l*4,y:o,vx:0,vy:0,color:"#b87333",highlight:"#e69138",inGoal:!1,movedThisTurn:!1,rotationZ:Math.random()*2*Math.PI,v_rotationZ:0},{id:2,x:.5+l*4,y:o,vx:0,vy:0,color:"#ffd700",highlight:"#fff200",inGoal:!1,movedThisTurn:!1,rotationZ:Math.random()*2*Math.PI,v_rotationZ:0}],c=((I=(T=t.rules)==null?void 0:T.timeRule)==null?void 0:I.enabled)||!1,u=((M=(x=t.rules)==null?void 0:x.timeRule)==null?void 0:M.timeLimitMs)||5*60*1e3,h=await Promise.all(Object.entries(t.players).map(async([P,A])=>{var R,B,C;return{uid:P,name:A.displayName,score:0,lives:((R=t.rules)==null?void 0:R.initialLives)||3,initialLives:((B=t.rules)==null?void 0:B.initialLives)||3,movesLeft:((C=t.rules)==null?void 0:C.minMoves)||3,turnCount:0,timeRemaining:c?u:null,isTimeEliminated:!1}}));let p=0;if(s){const P=h.findIndex(A=>A.uid===s);P!==-1&&(p=P)}else{const P=h.findIndex(A=>A.uid===t.host);P!==-1&&(p=P)}let v=null;if(c){v={};const P=firebase.database.ServerValue.TIMESTAMP;h.forEach(A=>{v[A.uid]={remaining:u,lastUpdate:P,eliminated:!1}})}const y={status:"in-progress",gameState:{status:"playing",players:h,coins:d,currentPlayerIndex:p,lastMovedCoinId:null,isPathFoulActive:!1,collisionOccurredDuringSim:!1,hostUid:a.uid,rules:t.rules||{collisionFoul:!0,sameCoinFoul:!0,initialLives:3,pathFoul:!0,fallFoul:!0,directGoalFoul:!0},gameStartTime:c?firebase.database.ServerValue.TIMESTAMP:null,activePlayerTurnStart:c?firebase.database.ServerValue.TIMESTAMP:null}};v&&(y.playerTimes=v,y.eliminated=null),await e.update(y)}deleteGameRoom(e,t="manual"){const s=this.database.ref(`games/${e}`);s.once("value",a=>{const i=a.val();if(!i)return;const r=this.auth.currentUser;if(!r)return;const n=i.host===r.uid,o=i.players&&i.players[r.uid];(n||o)&&s.remove().catch(l=>{console.warn("Could not delete game room (this is usually okay):",l.code)})}).catch(a=>{console.warn("Could not read game data for deletion:",a.code)})}setupEventListeners(){const e=document.getElementById("find-game-button");e&&e.addEventListener("click",()=>{this.loadAvailableGames(),this.showScreen("availableGames")});const t=document.getElementById("filter-games-modal"),s=document.getElementById("filter-games-button"),a=document.getElementById("close-filter-modal"),i=document.getElementById("apply-filters-button"),r=document.getElementById("reset-filters-button"),n=document.getElementById("filter-collision-foul"),o=document.getElementById("filter-same-coin-foul"),l=document.getElementById("sort-lives"),d=document.getElementById("sort-min-moves"),c=document.getElementById("sort-foul-rate"),u=()=>({collisionFoul:n.value,sameCoinFoul:o.value,sortLives:l.value,sortMinMoves:d.value,sortFoulRate:c.value}),h=()=>{n&&(n.value="any"),o&&(o.value="any"),l&&(l.value="none"),d&&(d.value="none"),c&&(c.value="none")};s&&s.addEventListener("click",()=>t.classList.remove("hidden")),a&&a.addEventListener("click",()=>t.classList.add("hidden")),i&&i.addEventListener("click",()=>{this.loadAvailableGames(u()),t.classList.add("hidden")}),r&&r.addEventListener("click",()=>{h(),this.loadAvailableGames(u()),t.classList.add("hidden")});const p=document.getElementById("create-private-game-button");p&&p.addEventListener("click",()=>{this.pendingGameType="private",this.showScreen("createGameSettings")});const v=document.getElementById("create-game-form");v&&v.addEventListener("submit",C=>{var L,w,E;C.preventDefault();const m=((L=document.getElementById("setting-time-rule-enabled"))==null?void 0:L.checked)||!1,g=parseInt(((w=document.getElementById("setting-time-limit"))==null?void 0:w.value)||5),S={collisionFoul:document.getElementById("setting-collision-foul").checked,sameCoinFoul:document.getElementById("setting-same-coin-foul").checked,initialLives:parseInt(document.getElementById("setting-lives").value),minMoves:parseInt(((E=document.getElementById("setting-min-moves"))==null?void 0:E.value)||3),pathFoul:!0,fallFoul:!0,directGoalFoul:!0,timeRule:m?{enabled:!0,timeLimitMs:g*60*1e3,timeLimitMinutes:g}:{enabled:!1}};this.pendingGameType==="private"?this.createPrivateGame(S):this.createPublicGame(S)});const f=document.getElementById("setting-lives"),y=document.getElementById("lives-display");f&&y&&f.addEventListener("input",C=>{y.textContent=C.target.value});const T=document.getElementById("setting-min-moves"),I=document.getElementById("min-moves-display");T&&I&&T.addEventListener("input",C=>{I.textContent=C.target.value});const x=document.getElementById("setting-time-rule-enabled"),M=document.getElementById("time-rule-settings"),P=document.getElementById("setting-time-limit"),A=document.getElementById("time-limit-display");x&&M&&x.addEventListener("change",C=>{C.target.checked?M.classList.remove("hidden"):M.classList.add("hidden")}),P&&A&&P.addEventListener("input",C=>{A.textContent=`${C.target.value} dk`});const R=document.getElementById("create-game-back-button");R&&R.addEventListener("click",()=>{this.pendingGameType==="public"?this.showScreen("availableGames"):this.showScreen("mainMenu")});const B=document.getElementById("join-game-button");B&&B.addEventListener("click",async()=>{var m;const C=(m=document.getElementById("join-game-input"))==null?void 0:m.value;C&&await this.joinGame(C)})}async toggleReady(){if(!this.currentGameId)return;const e=this.auth.currentUser,t=this.database.ref(`games/${this.currentGameId}/players/${e.uid}`),a=(await t.once("value")).val();a&&await t.update({ready:!a.ready})}async leaveLobby(){if(!this.currentGameId)return;const e=this.auth.currentUser,t=this.database.ref(`games/${this.currentGameId}`);try{await this.database.ref(`games/${this.currentGameId}/players/${e.uid}`).remove();const a=(await t.once("value")).val();(!a||!a.players||Object.keys(a.players).length===0)&&await t.remove()}catch(s){console.error("Error leaving lobby:",s)}this.listeners.game&&(t.off("value",this.listeners.game),this.listeners.game=null),this.listeners.rematch&&(rematchRef.off("value",this.listeners.rematch),this.listeners.rematch=null),this.currentGameId=null,window.currentGameId=null,this.showScreen("mainMenu")}setupRematchListener(e){const t=this.database.ref(`games/${e}/rematchReady`);this.listeners.rematch&&t.off("value",this.listeners.rematch),this.listeners.rematch=t.on("value",s=>{const a=s.val();!a||!window.gameManager||!window.uiManager||(window.uiManager.setGameData(this.auth,window.gameManager.players),window.uiManager.updateRematchStatus(a))})}cleanup(){}_sleep(e){return new Promise(t=>setTimeout(t,e))}getCurrentGameId(){return this.currentGameId}setCurrentGameId(e){this.currentGameId=e,window.currentGameId=e}}class le{constructor(e,t,s){this.auth=e,this.database=t,this.gameManager=s.gameManager,this.gameStatsManager=s.gameStatsManager,this.chatManager=s.chatManager,this.handleReturnToMainMenu=s.handleReturnToMainMenu,this.deleteGameRoom=s.deleteGameRoom,this.presenceManager=s.presenceManager,this.listeners={gameState:null,gameStatus:null,rematch:null,activeFlick:null,ack:null,playerLeft:null,coinToss:null}}async advanceTurn(e="turn_end",t=null){var p,v;if(!window.currentGameId||!(this.gameManager.hostUid===((p=this.auth.currentUser)==null?void 0:p.uid)))return;const a=this.database.ref(`games/${window.currentGameId}`),n=(await a.child("gameState").once("value")).val(),o=this.getNextStateForTurnEnd(n),l=t||((v=n.players[n.currentPlayerIndex])==null?void 0:v.uid),d=o.players[o.currentPlayerIndex];let c=null,u="info";if(e==="timeout"&&l){const f=n.players.find(y=>y.uid===l);f&&(c=`‚è±Ô∏è ${f.name} s√ºresini kullandƒ±!`,u="warning")}const h={gameState:{...o,status:o.status,overlayMessage:c?{text:c,type:u,requiresAck:!1}:o.overlayMessage},acknowledgedTurn:null};o.status==="gameOver"&&(h.gameState.overlayMessage&&h.gameState.overlayMessage.type==="info"||h.gameState.overlayMessage||(h.gameState.overlayMessage={text:"Oyun Bitti",type:"gameOver"})),await a.update(h),window.timeRuleManager&&window.timeRuleManager.initialized&&(l&&window.timeRuleManager.onTurnEnd(l),d&&!window.timeRuleManager.playerEliminated[d.uid]&&o.status!=="gameOver"&&window.timeRuleManager.onTurnStart(d.uid)),window.gameManager&&window.gameManager.startLocalRender&&window.gameManager.startLocalRender(()=>window.gameManager.coins),e==="timeout"&&setTimeout(async()=>{try{await a.child("gameState/overlayMessage").remove()}catch(f){console.warn("Could not auto-clear timeout message",f)}},3e3)}listenToGameState(e){const t=this.database.ref(`games/${e}/gameState`);this.listeners.gameState&&t.off("value",this.listeners.gameState);let s=null;this.listeners.gameState=t.on("value",r=>{var o,l,d;const n=r.val();if(n&&this.gameManager){this.presenceManager&&this.presenceManager.markGameStateUpdate(e);const c=n.status==="playing"||n.status==="simulating";if((!this.gameStatsManager.started||this.gameStatsManager.gameStartTime===null)&&c){const h=n.currentPlayerIndex!==void 0?n.currentPlayerIndex:0;if(this.gameStatsManager.startGameTimers(n.players,h),n.rules&&n.rules.timeRule&&n.rules.timeRule.enabled&&window.timeRuleManager){const p=n.hostUid===((o=this.auth.currentUser)==null?void 0:o.uid),v=n.players[h];window.timeRuleManager.initialize(e,n.players,n.rules.timeRule.timeLimitMs,p).then(()=>{v&&window.timeRuleManager.onTurnStart(v.uid)}).catch(f=>{})}navigator.vibrate&&navigator.vibrate([150,50,150])}const u=n.currentPlayerIndex!==void 0?n.currentPlayerIndex:0;if(s!==null&&s!==u&&window.timeRuleManager&&(d=(l=n.rules)==null?void 0:l.timeRule)!=null&&d.enabled&&window.timeRuleManager.initialized){const h=n.players[s],p=n.players[u];h&&window.timeRuleManager.onTurnEnd(h.uid),p&&window.timeRuleManager.onTurnStart(p.uid)}s=u,this.gameStatsManager.trackTurnChange(n),this.gameManager.updateState(n),n.status==="gameOver"&&(this.gameStatsManager.updatePlayerStats(e,n),this.gameStatsManager.resetGameTimers(),window.timeRuleManager&&window.timeRuleManager.cleanup(),navigator.vibrate&&navigator.vibrate([100,100,100,100,500]))}});const a=this.database.ref(`games/${e}`);this.listeners.gameStatus&&a.child("status").off("value",this.listeners.gameStatus),this.listeners.gameStatus=a.child("status").on("value",r=>{const n=r.val();n==="ended"?a.once("value",o=>{const l=o.val();if(!l)return;let d="‚ùå Oyun Sonlandƒ±rƒ±ldƒ±<br><br>Oyun beklenmedik ≈üekilde sonlandƒ±.";if(l.endReason==="player_disconnected"&&l.disconnectedPlayer){let c="Bir oyuncu";if(l.gameState&&l.gameState.players){const u=l.gameState.players.find(h=>h.uid===l.disconnectedPlayer);u&&(c=u.name)}d=`‚ùå Oyuncu Ayrƒ±ldƒ±<br><br>${c} oyundan ayrƒ±ldƒ±.<br>Oyun sonlandƒ±rƒ±ldƒ±.`}else if(l.endReason==="player_abandoned"&&l.abandonedBy){let c="Rakip";if(l.gameState&&l.gameState.players){const u=l.gameState.players.find(h=>h.uid===l.abandonedBy);u&&(c=u.name)}d=`‚ùå Oyuncu Ayrƒ±ldƒ±<br><br>${c} ana men√ºye d√∂nd√º.<br>Oyun sonlandƒ±rƒ±ldƒ±.`}window.timeRuleManager&&window.timeRuleManager.cleanup(),this.presenceManager&&this.presenceManager.cleanup(window.currentGameId),window.uiManager&&window.uiManager.showOverlay(d,"info",!1,!1),setTimeout(()=>{this.handleReturnToMainMenu()},3e3)}):n==="abandoned"&&a.once("value",o=>{const l=o.val();if(!l||window.currentUser&&l.abandonedBy===window.currentUser.uid)return;let d=l.abandonMessage||"‚ùå Oyun Terk Edildi<br><br>Rakibiniz oyunu terk etti.";window.timeRuleManager&&window.timeRuleManager.cleanup(),this.presenceManager&&this.presenceManager.cleanup(window.currentGameId),window.uiManager&&window.uiManager.showOverlay(d,"info",!1,!1),setTimeout(()=>{this.handleReturnToMainMenu()},3e3)})}),this.listenForRematch(e),this.presenceManager&&this.presenceManager.trackPlayerPresence(e);const i=this.database.ref(`games/${e}/playerLeft`);this.listeners.playerLeft=i.on("child_added",r=>{if(!r.val())return;const o=r.key,l=this.auth.currentUser;o!==l.uid&&a.once("value",d=>{const c=d.val();if(!c)return;let u="Rakip";if(c.gameState&&c.gameState.players){const h=c.gameState.players.find(p=>p.uid===o);h&&(u=h.name)}this.presenceManager&&this.presenceManager.cleanup(window.currentGameId),window.uiManager&&window.uiManager.showOverlay(`‚ùå Oyuncu Ayrƒ±ldƒ±<br><br>${u} oyundan ayrƒ±ldƒ±.<br>Oyun sonlandƒ±rƒ±ldƒ±.`,"info",!1,!1),setTimeout(()=>{this.handleReturnToMainMenu()},3e3)})}),this.listenForFlicks(e),this.listenForAcks(e),this.listenForCoinToss(e)}listenForCoinToss(e){const t=this.database.ref(`games/${e}/coinToss`);this.listeners.coinToss&&t.off("value",this.listeners.coinToss),this.listeners.coinToss=t.on("value",async s=>{const a=s.val();if(!a||!a.status){window.uiManager&&window.uiManager.hideCoinToss();return}const n=(await this.database.ref(`games/${e}`).once("value")).val(),o=n==null?void 0:n.players;if(!o||Object.keys(o).length<2)return;const l=Object.entries(o).map(([d,c])=>{var u;return{uid:d,name:c.displayName||((u=c.email)==null?void 0:u.split("@")[0])||"Oyuncu"}});a.status==="starting"&&window.uiManager?window.uiManager.showCoinToss(l,a.choices):a.status==="flipping"&&a.winnerUid&&window.uiManager?window.uiManager.setCoinTossWinner(a.winnerUid):a.status==="finished"&&window.uiManager})}listenForRematch(e){const t=this.database.ref(`games/${e}/rematchReady`);this.listeners.rematch&&t.off("value",this.listeners.rematch),this.listeners.rematch=t.on("value",s=>{const a=s.val();if(!a){const r=document.getElementById("rematch-status-container");r&&r.classList.add("hidden");return}this.gameManager&&this.gameManager.updateRematchStatus&&this.gameManager.updateRematchStatus(a),this.database.ref(`games/${e}`).once("value",r=>{const n=r.val();if(!n||!n.gameState)return;n.gameState.players.every(l=>a[l.uid])&&this.gameManager.hostUid===this.auth.currentUser.uid&&(t.remove(),window.networkManager&&window.networkManager.startGameWithToss())})})}listenForFlicks(e){const t=this.database.ref(`games/${e}/activeFlick`);this.listeners.activeFlick&&t.off("value",this.listeners.activeFlick),this.listeners.activeFlick=t.on("value",s=>{const a=s.val();if(!a)return;const i=this.auth.currentUser;if(!i)return;this.database.ref(`games/${e}/gameState`).once("value",n=>{const o=n.val();o&&(o.hostUid!==i.uid&&this.gameManager&&this.gameManager.runClientSimulation?this.gameManager.runClientSimulation(a,o):o.hostUid===i.uid&&this.gameManager&&this.gameManager.runHostSimulation&&this.gameManager.runHostSimulation(a,o,e))})})}listenForAcks(e){const t=this.database.ref(`games/${e}/acknowledgedTurn`);this.listeners.ack&&t.off("value",this.listeners.ack),this.listeners.ack=t.on("value",async s=>{var r;!s.val()||!(this.gameManager.hostUid===((r=this.auth.currentUser)==null?void 0:r.uid))||(await t.remove(),await this.advanceTurn())})}getNextStateForTurnEnd(e){var d;const t=e.currentPlayerIndex,s=e.players.length,a=((d=window.timeRuleManager)==null?void 0:d.playerEliminated)||{};let i=(t+1)%s,r=0;for(;r<s;){const c=e.players[i],u=a[c.uid];if(!(c.lives<=0)&&!u)break;i=(i+1)%s,r++}const n=this.getInitialCoinState();let o="playing";const l=e.players.filter(c=>c.lives>0&&!a[c.uid]);if(l.length===0&&(o="gameOver"),l.length===1&&s>1&&o==="playing"){const c=l[0],u=e.players.filter(p=>p.uid!==c.uid),h=Math.max(...u.map(p=>p.score||0));c.score>h&&(o="gameOver")}if(s===2&&o==="playing"){const c=e.players[0],u=e.players[1],h=a[c.uid],p=a[u.uid];((c.lives<=0||h)&&u.score>c.score||(u.lives<=0||p)&&c.score>u.score)&&(o="gameOver")}if(o==="gameOver"){const c=[...e.players].sort((v,f)=>f.score-v.score),u=c[0],h=c.length>1&&c[0].score===c[1].score;let p="";return h?p='ü§ù <span class="text-3xl font-bold">Berabere!</span> ü§ù':p=`üèÜ <span class="text-3xl font-bold">Kazanan: ${u.name}</span> üèÜ`,{...e,status:"gameOver",overlayMessage:{text:p,type:"info",requiresAck:!1}}}return{...e,status:"playing",currentPlayerIndex:i,overlayMessage:null,coins:n,lastMovedCoinId:null,collisionOccurredDuringSim:!1,goalScoredThisTurn:!1,fallFoulTriggered:!1,isPathFoulActive:!1}}getInitialCoinState(){const e=window.gameManager;if(!e)return[];const t=e.LOGICAL_HEIGHT/e.LOGICAL_WIDTH,s=e.COIN_DIAMETER_RATIO,a=t-t*.1,i=s/2;return[{id:0,x:.5,y:a,vx:0,vy:0,color:"#c0c0c0",highlight:"#f0f0f0"},{id:1,x:.5-i*4,y:a,vx:0,vy:0,color:"#b87333",highlight:"#e69138"},{id:2,x:.5+i*4,y:a,vx:0,vy:0,color:"#ffd700",highlight:"#fff200"}]}cleanup(){this.listeners.gameState&&(this.database.ref(`games/${window.currentGameId}/gameState`).off("value",this.listeners.gameState),this.listeners.gameState=null),this.listeners.gameStatus&&(this.database.ref(`games/${window.currentGameId}`).child("status").off("value",this.listeners.gameStatus),this.listeners.gameStatus=null),this.listeners.rematch&&(this.database.ref(`games/${window.currentGameId}/rematchReady`).off("value",this.listeners.rematch),this.listeners.rematch=null),this.listeners.activeFlick&&(this.database.ref(`games/${window.currentGameId}/activeFlick`).off("value",this.listeners.activeFlick),this.listeners.activeFlick=null),this.listeners.ack&&(this.database.ref(`games/${window.currentGameId}/acknowledgedTurn`).off("value",this.listeners.ack),this.listeners.ack=null),this.listeners.playerLeft&&(this.database.ref(`games/${window.currentGameId}/playerLeft`).off("child_added",this.listeners.playerLeft),this.listeners.playerLeft=null),this.presenceManager&&this.presenceManager.cleanup(window.currentGameId)}}class ce{constructor(){this.rematchButton=document.getElementById("rematch-button"),this.waitingText=document.getElementById("waiting-text"),this.ackButton=document.getElementById("ack-button"),this.gameOverlay=document.getElementById("game-overlay"),this.overlayText=document.getElementById("overlay-text"),this.overlayAnimation=document.getElementById("overlay-animation"),this.coinTossModal=document.getElementById("coin-toss-modal"),this.coinElement=document.getElementById("coin"),this.tossPlayer1Name=document.querySelector("#toss-player-1 .player-name"),this.tossPlayer2Name=document.querySelector("#toss-player-2 .player-name"),this.tossPlayer1Card=document.getElementById("toss-player-1"),this.tossPlayer2Card=document.getElementById("toss-player-2"),this.coinTossMessage=document.getElementById("coin-toss-message"),this.tossPlayer1Choice=document.querySelector("#toss-player-1 .player-choice"),this.tossPlayer2Choice=document.querySelector("#toss-player-2 .player-choice"),this.fireworksCanvas=document.getElementById("fireworks-canvas"),this.fireworksCtx=this.fireworksCanvas?this.fireworksCanvas.getContext("2d"):null,this.fireworks=[],this.fireworksHue=0,this.fireworksAnimationFrameId=null,this.auth=null,this.players=null,this.currentPlayerIndex=null,this.initializeMobileTabs()}showCoinToss(e,t=null){if(!(!this.coinTossModal||e.length<2)){if(this.coinTossPlayers=e,this.tossPlayer1Card.classList.remove("winner"),this.tossPlayer2Card.classList.remove("winner"),this.coinElement.classList.remove("flip-to-heads","flip-to-tails"),this.coinTossMessage.textContent="Yazƒ± tura atƒ±lƒ±yor...",this.tossPlayer1Name.textContent=e[0].name||"Oyuncu 1",this.tossPlayer2Name.textContent=e[1].name||"Oyuncu 2",t)this.coinTossChoices=t,this.tossPlayer1Choice.textContent=this.coinTossChoices[e[0].uid],this.tossPlayer2Choice.textContent=this.coinTossChoices[e[1].uid];else{const s=["Yazƒ±","Tura"],a=Math.random()<.5;this.tossPlayer1Choice.textContent=a?s[0]:s[1],this.tossPlayer2Choice.textContent=a?s[1]:s[0],this.coinTossChoices={[e[0].uid]:this.tossPlayer1Choice.textContent,[e[1].uid]:this.tossPlayer2Choice.textContent}}this.coinTossModal.classList.remove("hidden")}}setCoinTossWinner(e){if(!this.coinTossPlayers||!this.coinTossChoices)return;const t=this.coinTossPlayers.find(a=>a.uid===e);if(!t)return;this.coinElement.classList.remove("flip-to-heads","flip-to-tails");const s=this.coinTossChoices[t.uid];setTimeout(()=>{s==="Yazƒ±"?this.coinElement.classList.add("flip-to-heads"):this.coinElement.classList.add("flip-to-tails")},50),setTimeout(()=>{const a=this.coinTossPlayers[0];t.uid===a.uid?this.tossPlayer1Card.classList.add("winner"):this.tossPlayer2Card.classList.add("winner"),this.coinTossMessage.innerHTML=`<span class="text-yellow-300">${s} geldi!</span> <span class="text-amber-400">${t.name}</span> oyuna ba≈ülƒ±yor!`},3e3)}hideCoinToss(){this.coinTossModal&&this.coinTossModal.classList.add("hidden"),this.coinTossPlayers=null,this.coinTossChoices=null,this.coinElement.classList.remove("flip-to-heads","flip-to-tails")}initializeMobileTabs(){const e=document.querySelectorAll(".mobile-tab-button"),t=document.querySelector("#info-panels-container");if(!t||e.length===0)return;const s=t.querySelectorAll(".tab-panel");e.forEach(a=>{a.addEventListener("click",()=>{const i=a.dataset.tab;i==="chat-box"&&window.chatManager&&window.chatManager.clearChatNotifications(),e.forEach(n=>n.classList.remove("active-tab")),a.classList.add("active-tab"),s.forEach(n=>{n.classList.add("hidden")});const r=document.getElementById(i);r&&r.classList.remove("hidden")})}),e.length>0&&e[0].click()}setGameData(e,t,s=null){this.auth=e,this.players=t,s!==null&&(this.currentPlayerIndex=s)}getCoinGoalAnimation(e){if(e===1)return`
                <div class="coin-goal-animation coin-goal-type-1">
                    <div class="soccer-goal">
                        <div class="goal-post-left"></div>
                        <div class="goal-post-right"></div>
                        <div class="goal-crossbar"></div>
                        <div class="goal-net-pattern">
                            ${Array(8).fill(0).map((t,s)=>`
                                <div class="net-horizontal" style="--i: ${s}"></div>
                            `).join("")}
                            ${Array(12).fill(0).map((t,s)=>`
                                <div class="net-vertical" style="--i: ${s}"></div>
                            `).join("")}
                        </div>
                        <div class="goal-back-shadow"></div>
                    </div>
                    <div class="shooting-coin">ü™ô</div>
                    <div class="coin-trail">
                        <span style="--delay: 0s">‚ú®</span>
                        <span style="--delay: 0.05s">‚ú®</span>
                        <span style="--delay: 0.1s">‚ú®</span>
                        <span style="--delay: 0.15s">‚ú®</span>
                        <span style="--delay: 0.2s">‚ú®</span>
                    </div>
                    <div class="goal-flash"></div>
                    <div class="happy-player">
                        <div class="player-face">üòÑ</div>
                        <div class="celebration-text">GOOOOL!</div>
                    </div>
                </div>
            `;if(e===2)return`
                <div class="coin-goal-animation coin-goal-type-2">
                    <div class="soccer-goal big">
                        <div class="goal-post-left"></div>
                        <div class="goal-post-right"></div>
                        <div class="goal-crossbar"></div>
                        <div class="goal-net-pattern">
                            ${Array(8).fill(0).map((t,s)=>`
                                <div class="net-horizontal" style="--i: ${s}"></div>
                            `).join("")}
                            ${Array(12).fill(0).map((t,s)=>`
                                <div class="net-vertical" style="--i: ${s}"></div>
                            `).join("")}
                        </div>
                        <div class="goal-back-shadow"></div>
                        <div class="net-shake-effect"></div>
                    </div>
                    <div class="bouncing-coin">ü™ô</div>
                    <div class="bounce-effect">üí•</div>
                    <div class="goal-word">G‚öΩ‚öΩ‚öΩL!</div>
                    <div class="excited-player">
                        <div class="player-jumping">üôå</div>
                        <div class="joy-text">S√úPER GOL!</div>
                    </div>
                </div>
            `;if(e===3)return`
                <div class="coin-goal-animation coin-goal-type-3">
                    <div class="soccer-goal large">
                        <div class="goal-post-left"></div>
                        <div class="goal-post-right"></div>
                        <div class="goal-crossbar"></div>
                        <div class="goal-net-pattern">
                            ${Array(8).fill(0).map((t,s)=>`
                                <div class="net-horizontal" style="--i: ${s}"></div>
                            `).join("")}
                            ${Array(12).fill(0).map((t,s)=>`
                                <div class="net-vertical" style="--i: ${s}"></div>
                            `).join("")}
                        </div>
                        <div class="goal-back-shadow"></div>
                        <div class="corner-impact">
                            ${Array(8).fill(0).map((t,s)=>`
                                <span class="impact-particle" style="--angle: ${s*45}deg">üí´</span>
                            `).join("")}
                        </div>
                    </div>
                    <div class="spinning-coin-curved">ü™ô</div>
                    <div class="coin-spin-trail"></div>
                    <div class="victorious-player">
                        <div class="player-celebrating">üéâ</div>
                        <div class="victory-text">MUHTE≈ûEM GOL!</div>
                    </div>
                    <div class="golden-burst">
                        ${Array(12).fill(0).map((t,s)=>`
                            <div class="burst-ray" style="--angle: ${s*30}deg"></div>
                        `).join("")}
                    </div>
                </div>
            `}getFoulAnimation(e){return e.includes("√áarpƒ±≈üma")?`
                <div class="collision-animation">
                    <div class="collision-coin-left"></div>
                    <div class="collision-coin-right"></div>
                </div>
            `:e.includes("masadan d√º≈üt√º")?`
                <div class="fall-animation">
                    <div class="fall-coin"></div>
                    <div class="fall-table-edge"></div>
                </div>
            `:e.includes("Ba≈ülangƒ±√ßtan direkt")||e.includes("direkt gol")?`
                <div class="direct-goal-animation">
                    <div class="goal-net"></div>
                    <div class="direct-coin"></div>
                </div>
            `:e.includes("iki para arasƒ±ndan")||e.includes("ge√ßmelisin")?`
                <div class="path-animation">
                    <div class="path-coin-moving"></div>
                    <div class="path-coins-pair">
                        <div class="path-coin-static"></div>
                        <div class="path-coin-static"></div>
                    </div>
                </div>
            `:e.includes("T√ºm paralar oynanmadan")?`
                <div class="all-coins-animation">
                    <div class="coin"></div>
                    <div class="coin"></div>
                    <div class="coin"></div>
                </div>
            `:""}resetRematchButton(){this.rematchButton&&(this.rematchButton.innerHTML=`
                <span class="flex items-center gap-3 text-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Hazƒ±rƒ±m
                </span>
            `,this.rematchButton.disabled=!1,this.rematchButton.classList.remove("from-blue-500","to-blue-600","cursor-not-allowed"),this.rematchButton.classList.add("animate-pulse","from-green-500","to-emerald-600","hover:from-green-600","hover:to-emerald-700","hover:scale-110"),this.waitingText&&this.waitingText.classList.add("hidden"))}updateRematchStatus(e){const t=document.getElementById("rematch-status-container");if(!t)return;const s=this.auth.currentUser.uid;if(t.classList.remove("hidden"),t.innerHTML="",window.lastGamePointsEarned!==void 0&&window.lastGamePointsEarned!==null){const a=document.createElement("div");a.className="mb-4 p-4 rounded-xl bg-gradient-to-r from-amber-500/20 to-amber-600/20 border-2 border-amber-500";let i="";window.lastGamePointsEarned>0?i=`üéâ <span class="text-2xl font-bold text-amber-400">+${window.lastGamePointsEarned} Puan</span> Kazandƒ±n! üéâ`:i='<span class="text-lg font-semibold text-slate-300">Bu oyundan puan kazanamadƒ±n</span>',a.innerHTML=`
            <div class="text-center">
                ${i}
            </div>
        `,t.appendChild(a)}if(this.players.forEach(a=>{}),this.players.forEach(a=>{const i=e&&e[a.uid],r=a.uid===s,n=document.createElement("div");n.className=`
                    flex items-center justify-between p-4 rounded-xl transition-all duration-300
                    ${i?"bg-gradient-to-r from-green-600/30 to-emerald-600/30 border-2 border-green-500":"bg-gradient-to-r from-slate-700/50 to-slate-600/50 border-2 border-slate-500"}
                    ${r?"ring-2 ring-amber-400":""}
                `,n.innerHTML=`
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br ${i?"from-green-400 to-emerald-600":"from-slate-500 to-slate-700"} flex items-center justify-center text-white font-bold">
                            ${a.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-white flex items-center gap-2">
                                ${a.name}
                                ${r?'<span class="text-xs bg-amber-500 px-2 py-0.5 rounded-full">Sen</span>':""}
                            </div>
                            <div class="text-sm ${i?"text-green-300":"text-slate-400"}">
                                ${i?"‚úì Tekrar oynamak istiyor":"Bekleniyor..."}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${i?'<span class="px-3 py-1 bg-green-500 text-white text-sm font-bold rounded-full">Hazƒ±r</span>':'<span class="px-3 py-1 bg-slate-600 text-slate-300 text-sm font-semibold rounded-full">Bekliyor</span>'}
                    </div>
                `,t.appendChild(n)}),e&&e[s]){if(this.rematchButton&&(this.rematchButton.innerHTML=`
                        <span class="flex items-center gap-3 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Hazƒ±r! ‚úì
                        </span>
                    `,this.rematchButton.classList.remove("hidden","animate-pulse","from-green-500","to-emerald-600","hover:from-green-600","hover:to-emerald-700","hover:scale-110"),this.rematchButton.classList.add("from-blue-500","to-blue-600","cursor-not-allowed"),this.rematchButton.disabled=!0),this.waitingText){const a=this.players.filter(i=>!e[i.uid]).length;a>0?(this.waitingText.classList.remove("hidden"),this.waitingText.querySelector("span").textContent=`${a} oyuncu daha bekleniyor...`):this.waitingText.classList.add("hidden")}}else this.rematchButton&&!this.rematchButton.disabled&&this.resetRematchButton();t.classList.remove("hidden")}playGoalSound(){try{const e=new(window.AudioContext||window.webkitAudioContext);[523.25,659.25,783.99,1046.5].forEach((s,a)=>{const i=e.createOscillator(),r=e.createGain();i.connect(r),r.connect(e.destination),i.frequency.value=s,i.type="sine";const n=e.currentTime+a*.1,o=.15;r.gain.setValueAtTime(.3,n),r.gain.exponentialRampToValueAtTime(.01,n+o),i.start(n),i.stop(n+o)})}catch{}}startFireworks(){if(!this.fireworksCanvas||!this.fireworksCtx)return;this.fireworks=[],this.fireworksHue=0;const e=(a,i,r,n=!1)=>{const o=Math.random()*Math.PI*2,l=Math.random()*(n?15:10)+(n?8:5);return{x:a,y:i,vx:Math.cos(o)*l,vy:Math.sin(o)*l,alpha:1,decay:Math.random()*.03+.015,color:`hsl(${r}, 100%, ${n?70:50}%)`,size:n?3:2,trail:[]}},t=(a=!1)=>{const i=Math.random()*this.fireworksCanvas.width,r=this.fireworksCanvas.height,n=this.fireworksHue;this.fireworksHue=(this.fireworksHue+10)%360,this.fireworks.push({x:i,y:r,vx:(Math.random()-.5)*(a?15:10),vy:-(Math.random()*(a?20:15)+(a?25:20)),alpha:1,color:`hsl(${n}, 100%, ${a?70:50}%)`,life:60,exploded:!1,explosionParticles:[],isSpecial:a,trail:[]})};t(!0),setTimeout(()=>t(),200),setTimeout(()=>t(!0),400);const s=()=>{this.fireworksAnimationFrameId=requestAnimationFrame(s),this.fireworksCtx.fillStyle="rgba(0, 0, 0, 0.1)",this.fireworksCtx.fillRect(0,0,this.fireworksCanvas.width,this.fireworksCanvas.height);for(let a=this.fireworks.length-1;a>=0;a--){const i=this.fireworks[a];if(i.exploded)for(let r=i.explosionParticles.length-1;r>=0;r--){const n=i.explosionParticles[r];n.trail.push({x:n.x,y:n.y,alpha:n.alpha*.5}),n.trail.length>5&&n.trail.shift(),n.x+=n.vx,n.y+=n.vy,n.vy+=.3,n.vx*=.98,n.alpha-=n.decay,n.alpha<=n.decay&&i.explosionParticles.splice(r,1)}else if(i.trail.push({x:i.x,y:i.y,alpha:.5}),i.trail.length>10&&i.trail.shift(),i.x+=i.vx,i.y+=i.vy,i.vy+=.5,i.alpha-=.01,i.vy>=0||i.alpha<=.1||i.life<=0){i.exploded=!0;const r=i.isSpecial?100:60;for(let n=0;n<r;n++)i.explosionParticles.push(e(i.x,i.y,this.fireworksHue,i.isSpecial))}if(i.exploded&&i.explosionParticles.length===0&&this.fireworks.splice(a,1),this.fireworksCtx.save(),i.trail.forEach((r,n)=>{this.fireworksCtx.globalAlpha=r.alpha*(n/i.trail.length),this.fireworksCtx.fillStyle=i.color,this.fireworksCtx.beginPath(),this.fireworksCtx.arc(r.x,r.y,2,0,Math.PI*2),this.fireworksCtx.fill()}),this.fireworksCtx.restore(),this.fireworksCtx.save(),this.fireworksCtx.globalAlpha=i.alpha,this.fireworksCtx.fillStyle=i.color,this.fireworksCtx.shadowBlur=i.isSpecial?20:10,this.fireworksCtx.shadowColor=i.color,this.fireworksCtx.beginPath(),this.fireworksCtx.arc(i.x,i.y,i.isSpecial?4:3,0,Math.PI*2),this.fireworksCtx.fill(),this.fireworksCtx.restore(),i.exploded)for(const r of i.explosionParticles)this.fireworksCtx.save(),r.trail.forEach((n,o)=>{this.fireworksCtx.globalAlpha=n.alpha*(o/r.trail.length),this.fireworksCtx.fillStyle=r.color,this.fireworksCtx.beginPath(),this.fireworksCtx.arc(n.x,n.y,1,0,Math.PI*2),this.fireworksCtx.fill()}),this.fireworksCtx.globalAlpha=r.alpha,this.fireworksCtx.fillStyle=r.color,this.fireworksCtx.shadowBlur=15,this.fireworksCtx.shadowColor=r.color,this.fireworksCtx.beginPath(),this.fireworksCtx.arc(r.x,r.y,r.size,0,Math.PI*2),this.fireworksCtx.fill(),this.fireworksCtx.restore()}Math.random()<.08&&t(Math.random()<.3)};this.fireworksAnimationFrameId&&cancelAnimationFrame(this.fireworksAnimationFrameId),this.fireworksAnimationFrameId=requestAnimationFrame(s)}stopFireworks(){this.fireworksAnimationFrameId&&(cancelAnimationFrame(this.fireworksAnimationFrameId),this.fireworksAnimationFrameId=null),this.fireworksCtx&&this.fireworksCtx.clearRect(0,0,this.fireworksCanvas.width,this.fireworksCanvas.height),this.fireworks=[]}cleanup(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.physicsTimer&&(clearTimeout(this.physicsTimer),this.physicsTimer=null),window.uiManager.stopFireworks(),this.players=[],this.coins=[],this.currentPlayerIndex=0,this.gameState="setup",this.lastTurnOwnerUid=null,this.hostUid=null,this.isDragging=!1,this.selectedCoin=null,this.lastMovedCoinId=null,this.isPathFoulActive=void 0,this.renderer&&(this.renderer.coinImageAssignments={}),window.practiceMode&&(window.practiceMode={active:!1,goals:0,fouls:0,attempts:0,pendingFlick:null,pendingAck:null}),window.gameStatsManager&&window.gameStatsManager.resetGameTimers()}hideOverlay(){const e=document.getElementById("game-overlay"),t=document.getElementById("overlay-text");e&&(e.classList.add("hidden"),e.style.background="",e.style.backdropFilter=""),t&&(t.style.opacity=""),this.stopFireworks()}showOverlay(e,t="info",s=!1,a=!1,i=!1){var d,c;const r=document.getElementById("overlay-text"),n=document.getElementById("overlay-animation"),o=document.getElementById("game-overlay");if(!r||!o||!this.ackButton)return;if(i?(o.style.background="rgba(100,116,139,0.35)",o.style.backdropFilter="blur(1px)",r.style.opacity="0.85"):(o.style.background="",o.style.backdropFilter="",r.style.opacity=""),n&&(n.innerHTML=""),n){if(t==="foul"){const u=uiManager.getFoulAnimation(e);u&&(n.innerHTML=u),navigator.vibrate&&navigator.vibrate([400])}else if(t==="goal"){const u=Math.floor(Math.random()*3)+1;n.innerHTML=uiManager.getCoinGoalAnimation(u)}}if(t==="goal"?r.innerHTML="":r.innerHTML=e,o.classList.remove("hidden"),this.ackButton.classList.add("hidden"),this.rematchButton&&this.rematchButton.classList.add("hidden"),this.waitingText&&this.waitingText.classList.add("hidden"),t==="goal"?(uiManager.startFireworks(),navigator.vibrate&&navigator.vibrate([100,50,100,50,200,50,100,50,300]),o.style.animation="goal-flash 0.5s ease-out",setTimeout(()=>{o.style.animation=""},500),uiManager.playGoalSound()):window.uiManager.stopFireworks(),a||t==="gameOver"){if(window.practiceMode&&window.practiceMode.active){const u=document.getElementById("practice-menu-button");u&&u.classList.remove("hidden")}else if(this.rematchButton){if(uiManager.resetRematchButton(),window.currentGameId){const u=firebase.database().ref(`games/${window.currentGameId}/rematchReady`);u.once("value",h=>{h.exists()&&u.remove()})}this.rematchButton.classList.remove("hidden")}return}if(!this.players||this.currentPlayerIndex===null||!((d=this.auth)!=null&&d.currentUser))return;const l=((c=this.players[this.currentPlayerIndex])==null?void 0:c.uid)===this.auth.currentUser.uid;s&&l?this.ackButton.classList.remove("hidden"):!s&&!a&&t!=="gameOver"&&!i&&t!=="warning"&&setTimeout(()=>{this.hideOverlay()},2e3)}}const J=b=>b>=1e3?{name:"üíé Elmas Lig",tier:4,minPoints:1e3,maxPoints:999999}:b>=500?{name:"üëë Altƒ±n Lig",tier:3,minPoints:500,maxPoints:999}:b>=200?{name:"ü•à G√ºm√º≈ü Lig",tier:2,minPoints:200,maxPoints:499}:{name:"ü•â Bronz Lig",tier:1,minPoints:0,maxPoints:199},D=async(b,e,t)=>{if(!window.currentUser)return;const s=document.getElementById("user-welcome"),a=document.getElementById("user-level"),i=document.getElementById("user-rank"),r=document.getElementById("user-avatar"),n=document.getElementById("xp-progress");try{const o=await e(window.currentUser),l=await t(window.currentUser);if(s&&(s.textContent=`Ho≈ü geldin, ${l}!`),r){const L=l.charAt(0).toUpperCase();r.textContent=L}const u=(await b.ref(`users/${window.currentUser.uid}/stats`).once("value")).val()||{},h=u.totalPoints||0,p=Math.floor(h/100)+1,v=h%100,f=100;if(a&&(a.textContent=`Level ${p}`),n){const L=v/f*100;n.style.width=`${L}%`}const y=document.getElementById("xp-text-label");y&&(y.textContent=`${v}/${f} XP`);const T=J(h);i&&(i.textContent=T.name),window.currentUserRank=T;const I=u.wins||0,x=u.draws||0,M=u.losses||0,P=I+x+M,A=document.getElementById("wins-count");A&&(A.textContent=I);const R=document.getElementById("losses-count");R&&(R.textContent=M);const B=document.getElementById("total-games");B&&(B.textContent=P);const C=document.getElementById("draws-count");C&&(C.textContent=x);const m=document.getElementById("total-points");m&&(m.textContent=h);const g=document.getElementById("win-rate");if(g&&P>0){const L=Math.round(I/P*100);g.textContent=`${L}% oran`}const S=document.getElementById("loss-rate");if(S&&P>0){const L=Math.round(M/P*100);S.textContent=`${L}% oran`}}catch(o){console.error("Error updating main menu user info:",o)}},_=(b,e=null,t=null)=>{const s=e||window.screens;s&&typeof s=="object"&&Object.keys(s).forEach(a=>s[a]&&s[a].classList.toggle("hidden",a!==b)),b==="mainMenu"&&(window.DashboardManager&&window.DashboardManager.updateLeaderboard(),t&&typeof t=="function"&&t())},de=(b=5)=>Array.from({length:b},()=>"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(Math.random()*36))).join(""),j=(b,e)=>{if(b){const t=b.querySelector("span.flex-1");t?t.textContent=e:b.textContent=e,b.classList.toggle("hidden",!e)}},ue=b=>({length:b.length>=6,uppercase:/[A-Z]/.test(b),lowercase:/[a-z]/.test(b),number:/[0-9]/.test(b)}),me=b=>b.length&&b.uppercase&&b.lowercase&&b.number;class he{constructor(e,t){this.auth=e,this.database=t,this.profileForm=document.getElementById("profile-form"),this.profileFirstname=document.getElementById("profile-firstname"),this.profileLastname=document.getElementById("profile-lastname"),this.profileNickname=document.getElementById("profile-nickname"),this.profilePhone=document.getElementById("profile-phone"),this.profileEmailDisplay=document.getElementById("profile-email-display"),this.currentPassword=document.getElementById("current-password"),this.newPassword=document.getElementById("new-password"),this.newPasswordConfirm=document.getElementById("new-password-confirm"),this.displayRealname=document.getElementById("display-realname"),this.displayNickname=document.getElementById("display-nickname"),this.profileError=document.getElementById("profile-error"),this.profileSuccess=document.getElementById("profile-success"),this.profileSettingsButton=document.getElementById("profile-settings-button"),this.profileHomeButton=document.getElementById("profile-home-button")}initEventListeners(){this.profileForm&&this.profileForm.addEventListener("submit",e=>this.handleProfileSubmit(e)),this.profileSettingsButton&&this.profileSettingsButton.addEventListener("click",()=>this.showProfileScreen()),this.profileHomeButton&&this.profileHomeButton.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("profileHomeClicked"))})}async loadUserProfile(e){return(await this.database.ref(`users/${e.uid}/profile`).once("value")).val()}async saveUserProfile(e,t){await this.database.ref(`users/${e.uid}/profile`).set(t)}async getUserDisplayName(e){const t=await this.loadUserProfile(e);return t?t.displayPreference==="realname"&&t.firstname&&t.lastname?`${t.firstname} ${t.lastname}`:t.nickname?t.nickname:e.email?e.email.split("@")[0]:"Oyuncu":e.email?e.email.split("@")[0]:"Oyuncu"}async showProfileScreen(){const e=this.auth.currentUser;if(!e)return;_("profile",window.screens),this.profileEmailDisplay&&(this.profileEmailDisplay.value=e.email),this.currentPassword&&(this.currentPassword.value=""),this.newPassword&&(this.newPassword.value=""),this.newPasswordConfirm&&(this.newPasswordConfirm.value=""),j(this.profileError,""),j(this.profileSuccess,"");const t=await this.loadUserProfile(e);t&&(this.profileFirstname&&(this.profileFirstname.value=t.firstname||""),this.profileLastname&&(this.profileLastname.value=t.lastname||""),this.profileNickname&&(this.profileNickname.value=t.nickname||""),this.profilePhone&&(this.profilePhone.value=t.phone||""),t.displayPreference==="realname"?this.displayRealname&&(this.displayRealname.checked=!0):this.displayNickname&&(this.displayNickname.checked=!0)),window.DashboardManager&&e&&this.database.ref(`users/${e.uid}/stats`).once("value").then(s=>{const a=s.val();a&&(window.DashboardManager.userStats={wins:a.wins||0,draws:a.draws||0,losses:a.losses||0,gamesPlayed:a.gamesPlayed||0,totalPoints:a.totalPoints||0,totalGameTime:a.totalGameTime||0,level:a.level||1,xp:a.xp||0},window.DashboardManager.saveUserStats(),window.DashboardManager.updateDashboard(),this.updateProfileStats(a))}).catch(s=>{})}async changePassword(e,t){const s=this.auth.currentUser;if(!s||!s.email)throw new Error("Kullanƒ±cƒ± oturumu bulunamadƒ±");const a=window.firebase.auth.EmailAuthProvider.credential(s.email,e);try{return await s.reauthenticateWithCredential(a),await s.updatePassword(t),!0}catch(i){throw i.code==="auth/wrong-password"?new Error("Mevcut ≈üifre yanlƒ±≈ü"):i.code==="auth/weak-password"?new Error("Yeni ≈üifre √ßok zayƒ±f (en az 6 karakter)"):i}}updateProfileStats(e){if(!e)return;const t=document.getElementById("stat-total-points");t&&(t.textContent=e.totalPoints||0);const s=document.getElementById("stat-total-game-time");if(s&&e.totalGameTime){const i=r=>{const n=Math.floor(r/1e3),o=Math.floor(n/3600),l=Math.floor(n%3600/60),d=n%60;return`${String(o).padStart(2,"0")}:${String(l).padStart(2,"0")}:${String(d).padStart(2,"0")}`};s.textContent=i(e.totalGameTime)}const a=document.getElementById("stat-total-turn-time");if(a&&e.totalTurnTime){const i=r=>{const n=Math.floor(r/1e3),o=Math.floor(n/3600),l=Math.floor(n%3600/60),d=n%60;return`${String(o).padStart(2,"0")}:${String(l).padStart(2,"0")}:${String(d).padStart(2,"0")}`};a.textContent=i(e.totalTurnTime)}}async handleProfileSubmit(e){e.preventDefault();const t=this.auth.currentUser;if(!t)return;j(this.profileError,""),j(this.profileSuccess,"");const s=this.profileNickname.value.trim();if(!s){j(this.profileError,"Takma ad gereklidir.");return}const a={email:t.email,firstname:this.profileFirstname.value.trim(),lastname:this.profileLastname.value.trim(),nickname:s,phone:this.profilePhone.value.trim(),displayPreference:this.displayRealname.checked?"realname":"nickname",updatedAt:window.firebase.database.ServerValue.TIMESTAMP};try{await this.saveUserProfile(t,a);const i=this.currentPassword.value.trim(),r=this.newPassword.value.trim(),n=this.newPasswordConfirm.value.trim();if(i||r||n){if(!i)throw new Error("Mevcut ≈üifrenizi girmelisiniz.");if(!r)throw new Error("Yeni ≈üifrenizi girmelisiniz.");if(r!==n)throw new Error("Yeni ≈üifreler e≈üle≈ümiyor.");const o=ue(r);if(!me(o))throw new Error("Yeni ≈üifre gereksinimleri kar≈üƒ±lanmƒ±yor.");await this.changePassword(i,r),this.currentPassword.value="",this.newPassword.value="",this.newPasswordConfirm.value="",j(this.profileSuccess,"‚úì Profil ve ≈üifre kaydedildi!")}else j(this.profileSuccess,"‚úì Profil kaydedildi!");setTimeout(async()=>{document.dispatchEvent(new CustomEvent("profileUpdated",{detail:{user:t}}))},1e3)}catch(i){j(this.profileError,`Kayƒ±t hatasƒ±: ${i.message}`)}}}class ge{constructor(e,t,s){this.gameManager=e,this.database=t,this.physicsEngine=s,this.isSimulating=!1}stopSimulation(){this.isSimulating=!1;const e=this.gameManager;e&&e.physicsTimer&&(clearInterval(e.physicsTimer),e.physicsTimer=null),e&&e.stopLocalRender&&e.stopLocalRender()}generateAnimatedGoalText(){const e=["GOOOL!","M√úTHƒ∞≈û GOL!","OLEEYY!","TAM ƒ∞SABET!","GOL GOL GOL!"];return e[Math.floor(Math.random()*e.length)]}runHostSimulation(e,t,s){var v,f,y,T,I,x;const a=this.gameManager;a.physicsTimer&&clearInterval(a.physicsTimer),this.isSimulating=!0,window.practiceMode&&window.practiceMode.active&&window.practiceMode.attempts++;const i={collisionFoul:!0,fallFoul:!0,pathFoul:!0,directGoalFoul:!0,sameCoinFoul:!0,minMoves:3},r={collisionFoul:((v=t.rules)==null?void 0:v.collisionFoul)!==void 0?t.rules.collisionFoul:i.collisionFoul,fallFoul:((f=t.rules)==null?void 0:f.fallFoul)!==void 0?t.rules.fallFoul:i.fallFoul,pathFoul:((y=t.rules)==null?void 0:y.pathFoul)!==void 0?t.rules.pathFoul:i.pathFoul,directGoalFoul:((T=t.rules)==null?void 0:T.directGoalFoul)!==void 0?t.rules.directGoalFoul:i.directGoalFoul,sameCoinFoul:((I=t.rules)==null?void 0:I.sameCoinFoul)!==void 0?t.rules.sameCoinFoul:i.sameCoinFoul,minMoves:((x=t.rules)==null?void 0:x.minMoves)||i.minMoves},n=r.minMoves;let o=JSON.parse(JSON.stringify(t));o.status="simulating",o.collisionOccurredDuringSim=!1,o.goalScoredThisTurn=!1,o.fallFoulTriggered=!1;const l=a.LOGICAL_HEIGHT/a.LOGICAL_WIDTH,d=l-l*.1,c=o.coins.find(M=>M.id===e.coinId);if(!c)return;const u={x:c.x,y:c.y},h=Math.abs(c.y-d)<.001,p=o.players[o.currentPlayerIndex];if(p.turnCount=(p.turnCount||0)+1,c.vx=e.vx,c.vy=e.vy,c.movedThisTurn=!0,a.startLocalRender(()=>o.coins),r.sameCoinFoul&&t.lastMovedCoinId===e.coinId){a.stopLocalRender();let M=o.players[o.currentPlayerIndex];M.lives!==0&&M.lives--,window.practiceMode&&window.practiceMode.active&&window.practiceMode.fouls++,o.players.forEach(A=>{A.movesLeft=n});const P={...o,status:"awaiting_ack",players:o.players,overlayMessage:{text:"Faul:<br>Aynƒ± para ile √ºst √ºste oynanamaz",type:"foul",requiresAck:!0},isPathFoulActive:!0,collisionOccurredDuringSim:!1};window.practiceMode&&window.practiceMode.active?a.updateState(P):this.database.ref(`games/${s}/gameState`).set(P);return}a.physicsTimer=setInterval(async()=>{var A;if(!this.isSimulating){clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender();return}const M=this.physicsEngine.update(o.coins,o,!r.collisionFoul);if(M.collisionDetected)if(r.collisionFoul){if(clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender(),(await this.database.ref(`games/${s}/gameState/status`).once("value")).val()==="gameOver"){this.isSimulating=!1;return}let B=o.players[o.currentPlayerIndex];B.lives!==0&&B.lives--,window.practiceMode&&window.practiceMode.active&&window.practiceMode.fouls++,o.players.forEach(m=>{m.movesLeft=n});const C={...o,status:"awaiting_ack",players:o.players,overlayMessage:{text:"Faul:<br>√áarpƒ±≈üma",type:"foul",requiresAck:!0},isPathFoulActive:!0,collisionOccurredDuringSim:!0};window.practiceMode&&window.practiceMode.active?a.updateState(C):this.database.ref(`games/${s}/gameState`).set(C),this.isSimulating=!1;return}else o.collisionOccurredDuringSim=!0;if(M.goalScored&&(o.goalScoredThisTurn=!0),M.foulTriggered){if(clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender(),(await this.database.ref(`games/${s}/gameState/status`).once("value")).val()==="gameOver"){this.isSimulating=!1;return}let B=o.players[o.currentPlayerIndex];B.lives!==0&&B.lives--,window.practiceMode&&window.practiceMode.active&&window.practiceMode.fouls++,o.players.forEach(m=>{m.movesLeft=n});const C={...o,status:"awaiting_ack",players:o.players,overlayMessage:{text:"Faul:<br>Para masadan d√º≈üt√º",type:"foul",requiresAck:!0},isPathFoulActive:!0};window.practiceMode&&window.practiceMode.active?a.updateState(C):this.database.ref(`games/${s}/gameState`).set(C),this.isSimulating=!1;return}if(!M.isMoving){clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender();let R=[],B=o.goalScoredThisTurn,C;B&&o.coins.some(E=>!E.movedThisTurn)&&(R.push("T√ºm paralar oynanmadan gol atƒ±lamaz"),B=!1);const m=r.minMoves,g=o.players[o.currentPlayerIndex].movesLeft!==void 0?o.players[o.currentPlayerIndex].movesLeft:m;B&&g>0&&(R.push(`Gol i√ßin ${g} hamle daha yapmalƒ±sƒ±n`),B=!1),B&&r.directGoalFoul&&h&&(R.push("Ba≈ülangƒ±√ßtan direkt gol atƒ±lamaz"),B=!1),R.length===0&&r.collisionFoul&&o.collisionOccurredDuringSim&&R.push("√áarpƒ±≈üma"),R.length===0&&r.fallFoul&&o.fallFoulTriggered&&R.push("Para masadan d√º≈üt√º");const L=window.practiceMode&&window.practiceMode.active?window.practiceMode.attempts>1:o.isPathFoulActive;if(R.length===0&&r.pathFoul&&L){const E=o.coins.find(O=>O.id===e.coinId),H=o.coins.filter(O=>O.id!==e.coinId);if(E&&H.length===2){const O={x:E.x-u.x,y:E.y-u.y};Math.sqrt(O.x**2+O.y**2)>.001&&(this.physicsEngine.constructor.checkPathIntersection(u,O,H[0],H[1])||R.push("ƒ∞ki para arasƒ±ndan ge√ßmelisin"))}}if((await this.database.ref(`games/${s}/gameState/status`).once("value")).val()==="gameOver"){this.isSimulating=!1;return}if(B?(C={type:"goal",message:this.generateAnimatedGoalText()},o.players.forEach(E=>{E.movesLeft=m})):R.length>0?(C={type:"foul",message:`Faul:<br>${R.join("<br>")}`},o.players.forEach(E=>{E.movesLeft=m})):(C={type:"clean",message:""},o.players[o.currentPlayerIndex].movesLeft>0&&o.players[o.currentPlayerIndex].movesLeft--),C.type==="goal"||C.type==="foul"){let E=o.players[o.currentPlayerIndex];if(C.type==="goal"){E.score++,window.practiceMode&&window.practiceMode.active&&window.practiceMode.goals++;const $=((A=window.timeRuleManager)==null?void 0:A.playerEliminated)||{},G=o.players.filter(k=>$[k.uid]);if(G.length>0&&!$[E.uid]){const k=Math.max(...G.map(F=>F.score||0));if(E.score>k){let F=`üèÜ <span class="text-3xl font-bold">Kazanan: ${E.name}</span> üèÜ`;F+=`<br><span class="text-xl mt-2">Skor: ${E.score}</span>`;const N={...o,status:"gameOver",players:o.players,overlayMessage:{text:F,type:"gameOver"}};window.practiceMode&&window.practiceMode.active?a.updateState(N):this.database.ref(`games/${s}/gameState`).set(N);return}}}if(C.type==="foul"&&(E.lives!==0&&E.lives--,window.practiceMode&&window.practiceMode.active&&window.practiceMode.fouls++),(await this.database.ref(`games/${s}/gameState/status`).once("value")).val()==="gameOver"){this.isSimulating=!1;return}if(window.timeRuleManager&&window.timeRuleManager.eliminationInProgress){console.log("‚è±Ô∏è Simulation outcome aborted - time elimination in progress."),this.isSimulating=!1;return}const O={...o,status:"awaiting_ack",players:o.players,overlayMessage:{text:C.message,type:C.type,requiresAck:!0},isPathFoulActive:!0};window.practiceMode&&window.practiceMode.active?a.updateState(O):this.database.ref(`games/${s}/gameState`).set(O),this.isSimulating=!1}else{if((await this.database.ref(`games/${s}/gameState/status`).once("value")).val()==="gameOver"){this.isSimulating=!1;return}if(window.timeRuleManager&&window.timeRuleManager.eliminationInProgress){console.log("‚è±Ô∏è Clean move outcome aborted - time elimination in progress."),this.isSimulating=!1;return}const H={...o,status:"playing",lastMovedCoinId:e.coinId,overlayMessage:null,isPathFoulActive:!0};window.practiceMode&&window.practiceMode.active?a.updateState(H):this.database.ref(`games/${s}/gameState`).set(H),this.isSimulating=!1}}},1e3/60)}runClientSimulation(e,t,s){const a=this.gameManager;a.physicsTimer&&clearInterval(a.physicsTimer),this.isSimulating=!0;let i=JSON.parse(JSON.stringify(t));const r=i.coins.find(o=>o.id===e.coinId);if(!r)return;r.vx=e.vx,r.vy=e.vy;const n=t.rules||{collisionFoul:!0};a.startLocalRender(()=>i.coins),a.physicsTimer=setInterval(()=>{if(!this.isSimulating){clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender();return}const o=this.physicsEngine.update(i.coins,i,!n.collisionFoul);if(o.collisionDetected&&n.collisionFoul){clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender();return}if(o.goalScored||o.foulTriggered){clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender();return}o.isMoving||(clearInterval(a.physicsTimer),a.physicsTimer=null,a.stopLocalRender())},1e3/60)}}class fe{constructor(e,t,s,a,i){this.auth=e,this.database=t,this.gameManager=s,this.gameStatsManager=a,this.formatTime=i,this.lastGameStateUpdate={}}listenToGameState(e,t){const s=this.database.ref(`games/${e}/gameState`),a=this.database.ref(`games/${e}`);let i=null,r=null;return i&&s.off("value",i),i=s.on("value",o=>{const l=o.val();if(l&&this.gameManager){if(this.lastGameStateUpdate[e]=Date.now(),!this.gameStatsManager.started&&(l.status==="playing"||l.status==="simulating")){const d=l.currentPlayerIndex!==void 0?l.currentPlayerIndex:0;this.gameStatsManager.startGameTimers(l.players,d),navigator.vibrate&&navigator.vibrate([150,50,150])}this.gameStatsManager.trackTurnChange(l),this.gameManager.updateState(l),l.status==="gameOver"&&(this.gameStatsManager.updatePlayerStats(e,l),navigator.vibrate&&navigator.vibrate([100,100,100,100,500]),window.uiManager&&l.players&&(window.uiManager.setGameData(this.auth,l.players),window.uiManager.updateRematchStatus({})))}}),r&&a.child("status").off("value",r),r=a.child("status").on("value",o=>{const l=o.val();l==="ended"?a.once("value",d=>{const c=d.val();if(!c)return;let u="‚ùå Oyun Sonlandƒ±rƒ±ldƒ±<br><br>Oyun beklenmedik ≈üekilde sonlandƒ±.";if(c.endReason==="player_disconnected"&&c.disconnectedPlayer){let h="Bir oyuncu";if(c.gameState&&c.gameState.players){const p=c.gameState.players.find(v=>v.uid===c.disconnectedPlayer);p&&(h=p.name)}u=`‚ùå Oyuncu Ayrƒ±ldƒ±<br><br>${h} oyundan ayrƒ±ldƒ±.<br>Oyun sonlandƒ±rƒ±ldƒ±.`}else if(c.endReason==="player_abandoned"&&c.abandonedBy){let h="Rakip";if(c.gameState&&c.gameState.players){const p=c.gameState.players.find(v=>v.uid===c.abandonedBy);p&&(h=p.name)}u=`‚ùå Oyuncu Ayrƒ±ldƒ±<br><br>${h} ana men√ºye d√∂nd√º.<br>Oyun sonlandƒ±rƒ±ldƒ±.`}window.gameManager&&window.gameManager.showOverlay(u,"info",!1,!1),setTimeout(()=>{t()},3e3)}):l==="abandoned"&&a.once("value",d=>{const c=d.val();if(!c||window.currentUser&&c.abandonedBy===window.currentUser.uid)return;let u=c.abandonMessage||"‚ùå Oyun Terk Edildi<br><br>Rakibiniz oyunu terk etti.";window.gameManager&&window.gameManager.showOverlay(u,"info",!1,!1),setTimeout(()=>{t()},3e3)})}),this.database.ref(`games/${e}/playerLeft`).on("child_added",o=>{const l=o.key;o.val(),!(this.auth.currentUser&&l===this.auth.currentUser.uid)&&a.once("value",d=>{const c=d.val();if(c&&(c.status==="in-progress"||c.status==="playing")){let u="Rakip";if(c.gameState&&c.gameState.players){const h=c.gameState.players.find(p=>p.uid===l);h&&(u=h.name)}a.update({status:"ended",endReason:"player_abandoned",abandonedBy:l}),window.showToast&&window.showToast(`${u} oyundan ayrƒ±ldƒ±. Oyun sonlandƒ±rƒ±lƒ±yor...`,"warning",3e3)}})}),{gameStateListener:i,gameStatusListener:r}}getNextStateForTurnEnd(e){var f;let t=JSON.parse(JSON.stringify(e.players));const s=window.practiceMode&&window.practiceMode.active,a=t.filter(y=>s&&y.lives===0?!0:y.lives>0);let i=e.currentPlayerIndex,r="playing",n=null;const o=((f=window.timeRuleManager)==null?void 0:f.playerEliminated)||{},l=a.filter(y=>!o[y.uid]);if(l.length===0){r="gameOver";const y=[...t].sort((x,M)=>M.score-x.score),T=y[0].score,I=y.filter(x=>x.score===T);n=this._buildGameOverMessage(I,t)}else if(l.length===1&&t.length>1){const y=l[0],T=t.filter(x=>x.uid!==y.uid),I=Math.max(...T.map(x=>x.score||0));y.score>I?(r="gameOver",n=this._buildGameOverMessage([y],t)):i=t.findIndex(x=>x.uid===y.uid)}else{i=(e.currentPlayerIndex+1)%t.length;let y=0;for(;y<t.length;){const M=t[i],P=o[M.uid];if(s&&M.lives===0&&!P)break;if(M.lives>0&&!P)break;i=(i+1)%t.length,y++}const T=t[i],I=o[T.uid];if(!((s&&T.lives===0||T.lives>0)&&!I)){r="gameOver";const M=[...t].sort((R,B)=>B.score-R.score),P=M[0].score,A=M.filter(R=>R.score===P);n=this._buildGameOverMessage(A,t)}}const d=this.gameManager.COIN_DIAMETER_RATIO,c=this.gameManager.LOGICAL_HEIGHT/this.gameManager.LOGICAL_WIDTH,u=c-c*.1,h=d/2,p=[{id:0,x:.5,y:u,vx:0,vy:0,color:"#c0c0c0",highlight:"#f0f0f0",inGoal:!1,movedThisTurn:!1,rotationZ:Math.random()*2*Math.PI,v_rotationZ:0},{id:1,x:.5-h*4,y:u,vx:0,vy:0,color:"#b87333",highlight:"#e69138",inGoal:!1,movedThisTurn:!1,rotationZ:Math.random()*2*Math.PI,v_rotationZ:0},{id:2,x:.5+h*4,y:u,vx:0,vy:0,color:"#ffd700",highlight:"#fff200",inGoal:!1,movedThisTurn:!1,rotationZ:Math.random()*2*Math.PI,v_rotationZ:0}];return{status:r,players:t,coins:p,currentPlayerIndex:i,lastMovedCoinId:null,overlayMessage:n,isPathFoulActive:!!s,collisionOccurredDuringSim:!1,hostUid:e.hostUid||e.players&&e.players[0]&&e.players[0].uid}}_buildGameOverMessage(e,t){let s="",a="";if(e.length===1)s=`üèÜ <span class="text-3xl font-bold">Kazanan: ${e[0].name}</span> üèÜ`,a='<div class="mt-3 text-amber-300">+3 Puan</div>';else{s='ü§ù <span class="text-3xl font-bold">Berabere!</span> ü§ù';const o=e.map(l=>l.name).join(" & ");s+=`<div class="mt-2 text-2xl">${o}</div>`,a='<div class="mt-3 text-amber-300">+1 Puan (Her Oyuncu)</div>'}if(this.gameStatsManager&&this.gameStatsManager.currentTurnUid&&this.gameStatsManager.currentTurnStartTime){const o=Date.now()-this.gameStatsManager.currentTurnStartTime;this.gameStatsManager.playerTurnTimes[this.gameStatsManager.currentTurnUid]=(this.gameStatsManager.playerTurnTimes[this.gameStatsManager.currentTurnUid]||0)+o}const i=this.gameStatsManager.gameStartTime?Date.now()-this.gameStatsManager.gameStartTime:0,r=`<div class="mt-4 text-lg">‚è±Ô∏è Toplam S√ºre: <span class="font-semibold">${this.formatTime(i)}</span></div>`;let n='<div class="mt-3 space-y-1">';return t.forEach(o=>{const l=this.gameStatsManager.playerTurnTimes[o.uid]||0;n+=`<div class="text-sm">üë§ ${o.name}: <span class="font-semibold text-amber-200">${this.formatTime(l)}</span></div>`}),n+="</div>",{text:`${s}${a}${r}${n}`,type:"gameOver",requiresAck:!1}}listenForFlicks(e,t){const s=this.database.ref(`games/${e}/activeFlick`);return s.on("value",i=>{const r=i.val();if(!r)return;this.database.ref(`games/${e}/gameState`).once("value",o=>{var c,u;const l=o.val();if(!l||((c=l.players[l.currentPlayerIndex])==null?void 0:c.uid)!==r.madeBy)return;((u=l.players[0])==null?void 0:u.uid)===this.auth.currentUser.uid?(t.runHostSimulation(r,l,e),s.remove()):t.runClientSimulation(r,l,e)})})}getLastGameStateUpdate(e){return this.lastGameStateUpdate[e]||0}}class pe{constructor(e,t,s,a,i,r,n){this.auth=e,this.database=t,this.screens=s,this.showScreen=a,this.updateMainMenuUserInfo=i,this.loadUserProfile=r,this.getUserDisplayName=n,this.loginForm=null,this.registerForm=null,this.loginError=null,this.registerError=null}init(){this.loginForm=document.getElementById("login-form"),this.registerForm=document.getElementById("register-form"),this.showRegisterLink=document.getElementById("show-register"),this.showLoginLink=document.getElementById("show-login"),this.loginError=document.getElementById("login-error"),this.registerError=document.getElementById("register-error"),this.logoutButton=document.getElementById("logout-button"),this.setupEventListeners()}clearForm(e){if(e==="login")document.getElementById("login-email").value="",document.getElementById("login-password").value="",this.setFormError(this.loginError,"");else if(e==="register"){document.getElementById("register-email").value="",document.getElementById("register-password").value="",document.getElementById("register-password-confirm").value="",this.setFormError(this.registerError,"");const t=document.getElementById("password-requirements");t&&t.classList.add("hidden")}}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}setupEventListeners(){this.showRegisterLink&&this.showRegisterLink.addEventListener("click",t=>{t.preventDefault(),this.clearForm("login"),this.loginForm.classList.add("hidden"),this.registerForm.classList.remove("hidden")}),this.showLoginLink&&this.showLoginLink.addEventListener("click",t=>{t.preventDefault(),this.clearForm("register"),this.registerForm.classList.add("hidden"),this.loginForm.classList.remove("hidden")});const e=document.getElementById("register-password");e&&(e.addEventListener("input",t=>{this.updatePasswordRequirements(t.target.value)}),e.addEventListener("focus",()=>{const t=document.getElementById("password-requirements");e.value.length>0&&t.classList.remove("hidden")})),this.registerForm&&this.registerForm.addEventListener("submit",t=>this.handleRegister(t)),this.loginForm&&this.loginForm.addEventListener("submit",t=>this.handleLogin(t)),this.logoutButton&&this.logoutButton.addEventListener("click",()=>this.handleLogout()),this.setupInfoModal()}setupInfoModal(){const e=document.getElementById("info-button"),t=document.getElementById("info-modal"),s=document.getElementById("close-info-modal-btn"),a=document.getElementById("close-info-modal");e&&t&&(e.addEventListener("click",()=>{t.classList.remove("hidden"),document.body.style.overflow="hidden"}),s&&s.addEventListener("click",()=>{t.classList.add("hidden"),document.body.style.overflow=""}),a&&a.addEventListener("click",()=>{t.classList.add("hidden"),document.body.style.overflow=""}),t.addEventListener("click",i=>{i.target===t&&(t.classList.add("hidden"),document.body.style.overflow="")}),document.addEventListener("keydown",i=>{i.key==="Escape"&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),document.body.style.overflow="")}))}validatePassword(e){return{length:e.length>=6,uppercase:/[A-Z]/.test(e),lowercase:/[a-z]/.test(e),number:/[0-9]/.test(e)}}isPasswordValid(e){return e.length&&e.uppercase&&e.lowercase&&e.number}updatePasswordRequirements(e){const t=this.validatePassword(e),s=document.getElementById("password-requirements");if(!s)return;const a=(i,r)=>{const n=document.getElementById(i);n&&(r?(n.classList.remove("text-red-400"),n.classList.add("text-green-400"),n.querySelector(".requirement-icon").textContent="‚úì"):(n.classList.remove("text-green-400"),n.classList.add("text-red-400"),n.querySelector(".requirement-icon").textContent="‚úó"))};a("req-length",t.length),a("req-uppercase",t.uppercase),a("req-lowercase",t.lowercase),a("req-number",t.number),e.length>0?s.classList.remove("hidden"):s.classList.add("hidden")}getAuthErrorMessage(e,t){return{"auth/email-already-in-use":"Bu email adresi zaten kullanƒ±mda. Giri≈ü yapmayƒ± deneyin.","auth/invalid-email":"Ge√ßersiz email adresi formatƒ±.","auth/operation-not-allowed":"Bu i≈ülem ≈üu anda kullanƒ±lamƒ±yor. L√ºtfen daha sonra tekrar deneyin.","auth/weak-password":"≈ûifre √ßok zayƒ±f. En az 6 karakter ve b√ºy√ºk harf, k√º√ß√ºk harf, rakam i√ßermelidir.","auth/user-disabled":"Bu hesap devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈ü. Destek ile ileti≈üime ge√ßin.","auth/user-not-found":"Bu email adresi ile kayƒ±tlƒ± hesap bulunamadƒ±. L√ºtfen kayƒ±t olun.","auth/wrong-password":"Hatalƒ± ≈üifre girdiniz.","auth/invalid-credential":"Email veya ≈üifre hatalƒ±. Hesabƒ±nƒ±z yoksa kayƒ±t olun.","auth/too-many-requests":"√áok fazla ba≈üarƒ±sƒ±z deneme. L√ºtfen birka√ß dakika bekleyin.","auth/network-request-failed":"ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.","auth/requires-recent-login":"G√ºvenlik nedeniyle tekrar giri≈ü yapmanƒ±z gerekiyor."}[e]||t||"Bir hata olu≈ütu. L√ºtfen tekrar deneyin."}setFormError(e,t){e&&(e.textContent=t,e.classList.toggle("hidden",!t))}setButtonLoading(e,t){e&&(t?(e.disabled=!0,e.dataset.originalText=e.textContent,e.innerHTML=`
            <span class="inline-block mr-2 align-middle">
                <svg class="loading-hourglass" width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <path d="M6 2h12M6 22h12M8 2v2a6 6 0 0 0 2 4l2 2 2-2a6 6 0 0 0 2-4V2M8 22v-2a6 6 0 0 1 2-4l2-2 2 2a6 6 0 0 1 2 4v2" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span> Y√ºkleniyor...`):(e.disabled=!1,e.textContent=e.dataset.originalText||e.textContent))}async handleRegister(e){e.preventDefault();const t=document.getElementById("register-email").value.trim(),s=document.getElementById("register-password").value,a=document.getElementById("register-password-confirm").value,i=this.registerForm.querySelector("button");if(this.setFormError(this.registerError,""),!this.isValidEmail(t)){this.setFormError(this.registerError,"Ge√ßerli bir email adresi girin.");return}const r=this.validatePassword(s);if(!this.isPasswordValid(r)){let n=[];r.length||n.push("en az 6 karakter"),r.uppercase||n.push("b√ºy√ºk harf"),r.lowercase||n.push("k√º√ß√ºk harf"),r.number||n.push("rakam"),this.setFormError(this.registerError,`≈ûifre gereksinimleri kar≈üƒ±lanmƒ±yor: ${n.join(", ")}`);return}if(s!==a){this.setFormError(this.registerError,"≈ûifreler e≈üle≈ümiyor.");return}this.setButtonLoading(i,!0);try{await this.auth.createUserWithEmailAndPassword(t,s)}catch(n){const o=this.getAuthErrorMessage(n.code,n.message);this.setFormError(this.registerError,o)}finally{this.setButtonLoading(i,!1)}}async handleLogin(e){e.preventDefault();const t=document.getElementById("login-email").value.trim(),s=document.getElementById("login-password").value,a=this.loginForm.querySelector("button");if(this.setFormError(this.loginError,""),!t){this.setFormError(this.loginError,"Email adresinizi girin.");return}if(!this.isValidEmail(t)){this.setFormError(this.loginError,"Ge√ßerli bir email adresi girin.");return}if(!s){this.setFormError(this.loginError,"≈ûifrenizi girin.");return}this.setButtonLoading(a,!0);try{await this.auth.signInWithEmailAndPassword(t,s)}catch(i){let r;i.code==="auth/user-not-found"?r="Bu email adresi ile kayƒ±tlƒ± bir hesap bulunamadƒ±. L√ºtfen kayƒ±t olun.":i.code==="auth/wrong-password"?r="Hatalƒ± ≈üifre. L√ºtfen tekrar deneyin.":i.code==="auth/invalid-credential"||i.code==="auth/invalid-login-credentials"||i.code==="auth/internal-error"?r="Email adresiniz veya ≈üifreniz hatalƒ±. Hesabƒ±nƒ±z yoksa l√ºtfen kayƒ±t olun.":i.code==="auth/too-many-requests"?r="√áok fazla ba≈üarƒ±sƒ±z deneme. L√ºtfen birka√ß dakika sonra tekrar deneyin veya ≈üifrenizi sƒ±fƒ±rlayƒ±n.":i.code==="auth/user-disabled"?r="Bu hesap devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈ü. Destek ile ileti≈üime ge√ßin.":r=this.getAuthErrorMessage(i.code,i.message),this.setFormError(this.loginError,r)}finally{this.setButtonLoading(a,!1)}}handleLogout(){window.gameManager&&window.gameManager.cleanup(),this.auth.signOut()}setupPersistence(){this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)}setupAuthStateListener(e,t){this.auth.onAuthStateChanged(async s=>{s?await e(s):t()})}}class ye{constructor(e,t,s){this.auth=e,this.database=t,this.showToast=s,this.presenceListeners={},this.presenceInitialized={},this.gameStartTime={},this.lastGameStateUpdate={}}trackPlayerPresence(e){this.database.ref(`games/${e}`).once("value",s=>{const a=s.val();if(!a||!a.players)return;const i=this.auth.currentUser;if(!i)return;this.gameStartTime[e]||(this.gameStartTime[e]=Date.now());const r=this.database.ref(`games/${e}/presence/${i.uid}`);r.set(!0),r.onDisconnect().remove(),Object.keys(a.players).forEach(n=>{if(this.presenceListeners[n])return;const o=this.database.ref(`games/${e}/presence/${n}`);o.once("value",l=>{l.val()===!0||n===i.uid?this.presenceInitialized[n]=!0:this.presenceInitialized[n]=!1,this.presenceListeners[n]=o.on("value",c=>{const u=c.val();if(u===!0&&!this.presenceInitialized[n]){this.presenceInitialized[n]=!0;return}this.presenceInitialized[n]&&u===null&&n!==i.uid&&this.handlePlayerDisconnect(e,n)})})}),setTimeout(()=>{Object.keys(this.presenceInitialized).forEach(n=>{this.presenceInitialized[n]||(this.presenceInitialized[n]=!0)})},15e3)})}handlePlayerDisconnect(e,t){const s=Date.now();if(s-(this.gameStartTime[e]||s)<2e4)return;const i=window.gameLifecycleManager?window.gameLifecycleManager.getLastGameStateUpdate(e):this.lastGameStateUpdate[e]||0;if(s-i<3e3)return;const n=this.database.ref(`games/${e}`);n.once("value",o=>{const l=o.val();if(!l)return;const d=this.auth.currentUser;if(!d||t===d.uid||!["in-progress","waiting","playing","awaiting_ack","simulating"].includes(l.status))return;let u="Rakip";if(l.gameState&&l.gameState.players){const h=l.gameState.players.find(p=>p.uid===t);h&&(u=h.name)}else l.players&&l.players[t]&&(u=l.players[t].displayName||"Rakip");n.update({status:"ended",endReason:"player_disconnected",disconnectedPlayer:t}).then(()=>{this.cleanup(e),window.gameManager&&window.uiManager&&window.uiManager.showOverlay(`‚ùå Oyuncu Ayrƒ±ldƒ±<br><br>${u} oyundan ayrƒ±ldƒ±.<br>Oyun sonlandƒ±rƒ±ldƒ±.`,"info",!1,!1),window.deleteGameRoom&&setTimeout(()=>{window.deleteGameRoom(e,"player_disconnected")},2e3),window.handleReturnToMainMenu&&setTimeout(()=>{window.handleReturnToMainMenu()},3e3)})})}markGameStateUpdate(e){this.lastGameStateUpdate[e]=Date.now()}cleanup(e=null){e?(Object.keys(this.presenceListeners).forEach(t=>{const s=this.database.ref(`games/${e}/presence/${t}`);this.presenceListeners[t]&&s.off("value",this.presenceListeners[t])}),this.gameStartTime[e]&&delete this.gameStartTime[e],this.lastGameStateUpdate[e]&&delete this.lastGameStateUpdate[e]):(this.presenceListeners={},this.presenceInitialized={},this.gameStartTime={},this.lastGameStateUpdate={})}async removeOwnPresence(e){const t=this.auth.currentUser;if(!t||!e)return;await this.database.ref(`games/${e}/presence/${t.uid}`).remove()}}class we{constructor(e,t,s={}){this.auth=e,this.database=t,this.showScreen=s.showScreen,this.updateMainMenuUserInfo=s.updateMainMenuUserInfo,this.loadUserProfile=s.loadUserProfile,this.getUserDisplayName=s.getUserDisplayName,this.presenceManager=s.presenceManager,this.chatManager=s.chatManager,this.gameStatsManager=s.gameStatsManager,this.uiManager=s.uiManager,this.screens=s.screens}async cleanupStaleGames(){const e=this.auth.currentUser;if(!e||!(await this.database.ref(`users/${e.uid}/isAdmin`).once("value")).val())return;const r=await this.database.ref("games").limitToLast(200).once("value"),n=Date.now()-2*60*60*1e3,o=[];r.forEach(l=>{const d=l.val();if(!d)return;if(!d.players||Object.keys(d.players).length===0){const u=d.createdAt&&d.createdAt<n;(d.status==="lobby"||u)&&o.push(l.ref.remove())}}),o.length>0&&await Promise.all(o)}deleteGameRoom(e,t="manual"){const s=this.database.ref(`games/${e}`);s.once("value",a=>{const i=a.val();if(!i)return;const r=this.auth.currentUser;if(!r)return;const n=i.host===r.uid,o=i.players&&i.players[r.uid];(n||o)&&s.remove().then(()=>{}).catch(l=>{console.warn("Could not delete game room (this is usually okay):",l.code)})}).catch(a=>{console.warn("Could not read game data for deletion:",a.code)})}async handleReturnToMainMenu(){if(window.currentGameId&&this.auth.currentUser){const e=this.database.ref(`games/${window.currentGameId}`);try{const s=(await e.once("value")).val();s&&(await this.database.ref(`games/${window.currentGameId}/presence/${this.auth.currentUser.uid}`).remove(),(s.status==="in-progress"||s.status==="playing")&&(await e.update({[`playerLeft/${this.auth.currentUser.uid}`]:{timestamp:Date.now(),reason:"returned_to_menu"}}),s.gameState&&s.gameState.players&&s.gameState.players.some(r=>r.uid===this.auth.currentUser.uid)&&await e.update({status:"ended",endReason:"player_abandoned",abandonedBy:this.auth.currentUser.uid})),s.status==="lobby"&&s.players&&s.players[this.auth.currentUser.uid]&&(await this.database.ref(`games/${window.currentGameId}/players/${this.auth.currentUser.uid}`).remove(),s.host===this.auth.currentUser.uid&&await e.remove()))}catch(t){console.error("Error during cleanup:",t)}}if(this.presenceManager&&this.presenceManager.cleanup(window.currentGameId),this.chatManager&&this.chatManager.cleanupListener(),this.gameStatsManager&&(this.gameStatsManager.stopGameTimers(),this.gameStatsManager.resetGameTimers()),this.cleanupFirebaseListeners(),window.gameManager&&(window.gameManager.physicsTimer&&(clearInterval(window.gameManager.physicsTimer),window.gameManager.physicsTimer=null),window.gameManager.animationFrameId&&(cancelAnimationFrame(window.gameManager.animationFrameId),window.gameManager.animationFrameId=null),this.uiManager&&(this.uiManager.stopFireworks(),this.uiManager.cleanup())),window.currentGameId){const e=window.currentGameId,t=this.database.ref(`games/${e}`);try{const a=(await t.once("value")).val();if(a){const i=a.status;i==="gameOver"||i==="ended"?this.deleteGameRoom(e,"game_completed"):(i==="playing"||i==="waiting"||i==="awaiting_ack"||i==="simulating")&&(await t.update({status:"abandoned",abandonedBy:window.currentUser?window.currentUser.uid:"unknown",abandonedAt:Date.now(),abandonMessage:`${window.currentUser&&window.currentUser.displayName||"Bir oyuncu"} oyunu terk etti.`}),setTimeout(()=>{this.deleteGameRoom(e,"player_abandoned")},2e3))}}catch(s){console.error("Error handling game exit:",s),this.deleteGameRoom(e,"cleanup_error")}}window.lobbyAlertShown=!1,window.currentGameId=null,this.showScreen&&this.screens&&this.showScreen("mainMenu",this.screens,()=>{this.updateMainMenuUserInfo&&this.updateMainMenuUserInfo(this.database,this.loadUserProfile,this.getUserDisplayName)})}cleanupFirebaseListeners(){window.cleanupGameListeners&&window.cleanupGameListeners()}}class ve{constructor(e,t,s,a){this.auth=e,this.database=t,this.gameManager=s,this.uiManager=a,this.SYNC_INTERVAL=5e3,this.CLOCK_CORRECTION_THRESHOLD=1e3,this.WARNING_THRESHOLD=3e4,this.CRITICAL_THRESHOLD=1e4,this.initialized=!1,this.isHost=!1,this.gameCode=null,this.playerTimes={},this.playerEliminated={},this.activePlayerUid=null,this.turnStartTime=null,this.serverTimeOffset=0,this.eliminationInProgress=!1,this.countdownInterval=null,this.syncInterval=null,this.eliminationTimeout=null,this.timeListener=null,this.eliminationListener=null}async initialize(e,t,s,a){this.cleanup(),this.gameCode=e,this.isHost=a,this.initialized=!1,await this.calculateServerTimeOffset(),t.forEach(i=>{this.playerTimes[i.uid]=s,this.playerEliminated[i.uid]=!1}),this.isHost&&(await this.database.ref(`games/${this.gameCode}/eliminated`).remove(),await this.syncTimesToFirebase()),this.setupTimeListener(),this.setupEliminationListener(),this.startCountdownDisplay(),this.initialized=!0}async calculateServerTimeOffset(){const t=await this.database.ref(".info/serverTimeOffset").once("value");this.serverTimeOffset=t.val()||0}getSyncedTime(){return Date.now()+this.serverTimeOffset}cleanup(){this.initialized=!1,this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null),this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.eliminationTimeout&&(clearTimeout(this.eliminationTimeout),this.eliminationTimeout=null),this.timeListener&&this.gameCode&&(this.database.ref(`games/${this.gameCode}/playerTimes`).off("value",this.timeListener),this.timeListener=null),this.eliminationListener&&this.gameCode&&(this.database.ref(`games/${this.gameCode}/eliminated`).off("child_added",this.eliminationListener),this.eliminationListener=null),this.playerTimes={},this.playerEliminated={},this.activePlayerUid=null,this.turnStartTime=null,this.gameCode=null,this.eliminationInProgress=!1}onTurnStart(e){if(this.activePlayerUid&&this.turnStartTime){const t=this.getSyncedTime()-this.turnStartTime;this.playerTimes[this.activePlayerUid]=Math.max(0,(this.playerTimes[this.activePlayerUid]||0)-t)}this.activePlayerUid=e,this.turnStartTime=this.getSyncedTime(),this.isHost&&this.scheduleEliminationCheck(e),this.isHost&&!this.syncInterval&&this.startSyncInterval()}onTurnEnd(e){if(this.activePlayerUid===e&&this.turnStartTime){const t=this.getSyncedTime()-this.turnStartTime;this.playerTimes[e]=Math.max(0,(this.playerTimes[e]||0)-t),this.eliminationTimeout&&(clearTimeout(this.eliminationTimeout),this.eliminationTimeout=null),this.isHost&&this.syncTimesToFirebase()}this.turnStartTime=null}getRemainingTime(e){let t=this.playerTimes[e]||0;if(this.activePlayerUid===e&&this.turnStartTime){const s=this.getSyncedTime()-this.turnStartTime;t=Math.max(0,t-s)}return t}isPlayerEliminated(e){return this.playerEliminated[e]===!0}scheduleEliminationCheck(e){if(!this.isHost||!this.initialized)return;this.eliminationTimeout&&clearTimeout(this.eliminationTimeout);const t=this.getRemainingTime(e);t<=0?this.eliminatePlayer(e):this.eliminationTimeout=setTimeout(()=>{this.eliminatePlayer(e)},t+100)}async eliminatePlayer(e){if(!(!this.isHost||!this.gameCode||!this.initialized)&&!this.eliminationInProgress){this.eliminationInProgress=!0;try{this.forceStopSimulation();const a=(await this.database.ref(`games/${this.gameCode}/gameState`).once("value")).val();if(a&&a.status==="gameOver"||this.playerEliminated[e])return;await this.clearPendingAckState(),this.playerEliminated[e]=!0,this.playerTimes[e]=0;const i={};i[`games/${this.gameCode}/eliminated/${e}`]={timestamp:firebase.database.ServerValue.TIMESTAMP,reason:"time_expired"},i[`games/${this.gameCode}/playerTimes/${e}/remaining`]=0,i[`games/${this.gameCode}/playerTimes/${e}/eliminated`]=!0,await this.database.ref().update(i),await this.checkGameEndOrPassTurn(e)}finally{this.eliminationInProgress=!1}}}async clearPendingAckState(){const e=this.database.ref(`games/${this.gameCode}/gameState`),s=(await e.once("value")).val();if(!s)return;this.forceStopSimulation();const a=this.getInitialCoinState();if(["awaiting_ack","simulating","playing"].includes(s.status)){await this.database.ref(`games/${this.gameCode}`).update({acknowledgedTurn:null,activeFlick:null}),await e.update({status:"playing",overlayMessage:null,coins:a,lastMovedCoinId:null,isPathFoulActive:!1,collisionOccurredDuringSim:!1}),window.uiManager&&window.uiManager.hideOverlay();const r=document.getElementById("ack-button");r&&r.classList.add("hidden"),window.uiManager&&window.uiManager.stopFireworks()}}forceStopSimulation(){window.simulationManager&&(window.simulationManager.isSimulating=!1,window.simulationManager.stopSimulation&&window.simulationManager.stopSimulation()),window.gameManager&&window.gameManager.physicsTimer&&(clearInterval(window.gameManager.physicsTimer),window.gameManager.physicsTimer=null),window.gameManager&&window.gameManager.stopLocalRender&&window.gameManager.stopLocalRender()}async checkGameEndOrPassTurn(e){if(!this.isHost||!this.gameCode)return;const a=(await this.database.ref(`games/${this.gameCode}`).once("value")).val();if(!a||!a.gameState||!a.gameState.players||a.gameState.status==="gameOver")return;const i=a.gameState.players;i.filter(n=>!this.playerEliminated[n.uid]).length===0?await this.endGameByScore(i):await this.passToNextActivePlayer(i,e)}async endGameByScore(e){this.stopAllTimers(),this.forceStopSimulation();const t=this.database.ref(`games/${this.gameCode}/gameState`),s=Math.max(...e.map(n=>n.score||0)),a=e.filter(n=>(n.score||0)===s);let i;a.length===1?i=`‚è±Ô∏è S√ºre Bitti!<br>üèÜ ${a[0].name} Kazandƒ±! üèÜ<br>(En y√ºksek skor: ${s})`:s===0?i="‚è±Ô∏è S√ºre Bitti!<br>ü§ù Berabere! ü§ù<br>(Her iki oyuncu da 0 puan)":i=`‚è±Ô∏è S√ºre Bitti!<br>ü§ù Berabere! ü§ù<br>(Her iki oyuncu da ${s} puan)`;const r=e.map(n=>({...n,isTimeEliminated:!0}));await t.update({status:"gameOver",winner:a.length===1?a[0].uid:null,endReason:"all_time_expired",overlayMessage:{text:i,type:"gameOver"},players:r}),this.cleanup()}stopAllTimers(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null),this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.eliminationTimeout&&(clearTimeout(this.eliminationTimeout),this.eliminationTimeout=null),this.activePlayerUid=null,this.turnStartTime=null}async passToNextActivePlayer(e,t=null){const i=(await this.database.ref(`games/${this.gameCode}/gameState`).once("value")).val();if(!i||i.status==="gameOver")return;let r=i.currentPlayerIndex||0;const n=e.length;for(let o=1;o<=n;o++){const l=(r+o)%n,d=e[l];if(!this.playerEliminated[d.uid]){window.gameStateManager&&window.gameStateManager.advanceTurn?await window.gameStateManager.advanceTurn("timeout",t):console.error("‚ùå GameStateManager or advanceTurn not found!");return}}await this.endGameByScore(e)}getInitialCoinState(){const e=this.gameManager||window.gameManager;if(!e)return[{id:0,x:.5,y:.8,vx:0,vy:0,color:"#c0c0c0",highlight:"#f0f0f0",inGoal:!1,movedThisTurn:!1},{id:1,x:.5-.04*4,y:.8,vx:0,vy:0,color:"#b87333",highlight:"#e69138",inGoal:!1,movedThisTurn:!1},{id:2,x:.5+.04*4,y:.8,vx:0,vy:0,color:"#ffd700",highlight:"#fff200",inGoal:!1,movedThisTurn:!1}];const t=e.LOGICAL_HEIGHT/e.LOGICAL_WIDTH,s=e.COIN_DIAMETER_RATIO,a=t-t*.1,i=s/2;return[{id:0,x:.5,y:a,vx:0,vy:0,color:"#c0c0c0",highlight:"#f0f0f0",inGoal:!1,movedThisTurn:!1},{id:1,x:.5-i*4,y:a,vx:0,vy:0,color:"#b87333",highlight:"#e69138",inGoal:!1,movedThisTurn:!1},{id:2,x:.5+i*4,y:a,vx:0,vy:0,color:"#ffd700",highlight:"#fff200",inGoal:!1,movedThisTurn:!1}]}setupTimeListener(){if(!this.gameCode)return;const e=this.database.ref(`games/${this.gameCode}/playerTimes`);this.timeListener=e.on("value",t=>{const s=t.val();s&&(this.isHost||Object.entries(s).forEach(([a,i])=>{if(i.eliminated)this.playerEliminated[a]=!0,this.playerTimes[a]=0;else if(i.remaining!==void 0){const r=this.playerTimes[a]||0;Math.abs(r-i.remaining)>this.CLOCK_CORRECTION_THRESHOLD&&(this.playerTimes[a]=i.remaining,this.activePlayerUid===a&&i.lastUpdate&&(this.turnStartTime=i.lastUpdate))}}))})}setupEliminationListener(){if(!this.gameCode)return;const e=this.database.ref(`games/${this.gameCode}/eliminated`);this.eliminationListener=e.on("child_added",t=>{const s=t.key;t.val(),s&&!this.playerEliminated[s]&&(this.playerEliminated[s]=!0,this.playerTimes[s]=0,this.updateTimeDisplay(),navigator.vibrate&&navigator.vibrate([200,100,200]))})}async syncTimesToFirebase(){if(!this.isHost||!this.gameCode)return;const e={},t=this.getSyncedTime();Object.entries(this.playerTimes).forEach(([s,a])=>{let i=a;if(this.activePlayerUid===s&&this.turnStartTime){const r=t-this.turnStartTime;i=Math.max(0,a-r)}e[s]={remaining:i,lastUpdate:t,eliminated:this.playerEliminated[s]||!1}}),await this.database.ref(`games/${this.gameCode}/playerTimes`).set(e)}startSyncInterval(){!this.isHost||this.syncInterval||(this.syncInterval=setInterval(()=>{this.syncTimesToFirebase()},this.SYNC_INTERVAL))}startCountdownDisplay(){this.countdownInterval&&clearInterval(this.countdownInterval),this.countdownInterval=setInterval(()=>{this.updateTimeDisplay()},100)}updateTimeDisplay(){!this.gameManager||!this.gameManager.players||this.gameManager.players.forEach((e,t)=>{var o;const s=this.getRemainingTime(e.uid),a=this.isPlayerEliminated(e.uid),i=t===this.gameManager.currentPlayerIndex,r=(o=this.gameManager.scoreboardCache)==null?void 0:o.get(e.uid);if(!r||!r.card)return;let n=r.card.querySelector(".player-time-remaining");if(n||(n=document.createElement("div"),n.className="player-time-remaining text-center mt-2 font-mono",r.card.appendChild(n)),a)n.innerHTML=`
                    <span class="text-red-500 font-bold">‚è±Ô∏è ELENDƒ∞</span>
                `,n.className="player-time-remaining text-center mt-2 font-mono opacity-50";else{let l="text-green-400",d="";s<=this.CRITICAL_THRESHOLD?(l="text-red-500",d="animate-pulse"):s<=this.WARNING_THRESHOLD&&(l="text-amber-400");const c=this.formatCountdownTime(s),u=i?"üéØ ":"";n.innerHTML=`
                    <span class="${l} ${d} font-bold">
                        ${u}‚è±Ô∏è ${c}
                    </span>
                `,n.className="player-time-remaining text-center mt-2 font-mono"}})}formatCountdownTime(e){if(e<=0)return"00:00";const t=Math.ceil(e/1e3),s=Math.floor(t/60),a=t%60;return`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}static getTimeRuleConfig(e){return{enabled:!0,timeLimitMs:e*60*1e3,timeLimitMinutes:e}}static parseTimeLimit(e){return!e||!e.timeRule||!e.timeRule.enabled?null:e.timeRule.timeLimitMs||null}}const Q={MENU_UPDATE_DELAY:100,CLEANUP_DELAY:7e3};document.addEventListener("DOMContentLoaded",()=>{if(window.SKIP_APP_INIT)return;if(typeof window.firebase>"u"||typeof auth>"u"||typeof database>"u"){try{if(!document.getElementById("fatal-error-banner")){const g=document.createElement("div");g.id="fatal-error-banner",g.style.position="fixed",g.style.inset="0",g.style.background="rgba(127,29,29,0.96)",g.style.color="white",g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.zIndex="9999",g.style.padding="24px",g.innerHTML='<div style="max-width:700px;text-align:center;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;">                    <h2 style="font-size:26px;margin-bottom:10px;">Baƒülantƒ± Sorunu</h2>                    <p style="font-size:15px;line-height:1.6;margin-bottom:12px;">Firebase SDK veya yapƒ±landƒ±rmasƒ± y√ºklenemedi. ƒ∞nternet/kurumsal aƒü engellerini kontrol edin. Gerekirse yerel sunucu ile √ßalƒ±≈ütƒ±rƒ±n.</p>                    <code style="background:rgba(255,255,255,0.1);padding:6px 10px;border-radius:6px;display:inline-block;">Failed to load Firebase SDK (ERR_EMPTY_RESPONSE?)</code>                </div>',document.body.appendChild(g)}}catch(m){console.warn("Failed to create Firebase error banner:",m)}console.error("Firebase not available. Aborting app bootstrap.");return}ae();const b=new ce;window.uiManager=b;const e=document.getElementById("gameCanvas");if(!e)return;const t=e.getContext("2d"),s=document.getElementById("game-container"),a=document.getElementById("player-list");document.getElementById("overlay-text"),window.gameManager={players:[],coins:[],currentPlayerIndex:0,gameState:"setup",lastTurnOwnerUid:null,hostUid:null,isDragging:!1,dragStart:{x:0,y:0},dragEnd:{x:0,y:0},selectedCoin:null,physicsTimer:null,animationFrameId:null,lastMovedCoinId:null,ackButton:null,rematchButton:null,waitingText:null,fireworksCanvas:null,fireworksCtx:null,renderer:new ie(e,t,s),inputHandler:null,physicsEngine:null,lastScoreboardState:null,lastPlayerIndex:null,lastGameState:null,scoreboardCache:new Map,LOGICAL_WIDTH:600,LOGICAL_HEIGHT:1e3,COIN_DIAMETER_RATIO:.1,GOAL_WIDTH_RATIO:.3,updateState(m){var O,$;const g=document.getElementById("game-overlay");this.players=m.players||this.players,this.gameState!=="playing"&&this.gameState!=="simulating"&&m.status==="playing"&&(this.gameResultRecorded=!1,window.lastGamePointsEarned=null,this.renderer&&m.coins&&this.renderer.assignRandomCoinImages(m.coins)),m.hostUid&&(this.hostUid=m.hostUid),m.rules&&(this.rules=m.rules),m.coins&&(!this.physicsTimer||m.status==="playing"||m.status==="awaiting_ack")&&(this.coins=JSON.parse(JSON.stringify(m.coins)),this.draw()),this.currentPlayerIndex=m.currentPlayerIndex!==void 0?m.currentPlayerIndex:this.currentPlayerIndex;const w=this.gameState==="gameOver";this.gameState=m.status||this.gameState;const E=this.gameState==="playing";if(w&&E&&a){a.removeAttribute("data-initialized");const G=document.getElementById("rematch-status-container");G&&(G.classList.add("hidden"),G.innerHTML=""),window.currentGameId&&database.ref(`games/${window.currentGameId}/rematchReady`).remove(),b.resetRematchButton();const k=document.getElementById("overlay-animation");k&&(k.innerHTML="")}if(this.lastMovedCoinId=m.lastMovedCoinId,m.isPathFoulActive!==void 0&&(this.isPathFoulActive=m.isPathFoulActive),(!this.lastScoreboardState||JSON.stringify(this.players.map(G=>({score:G.score,lives:G.lives,movesLeft:G.movesLeft,uid:G.uid})))!==this.lastScoreboardState||this.currentPlayerIndex!==this.lastPlayerIndex||this.gameState!==this.lastGameState)&&(this.updateScoreboard(),this.lastScoreboardState=JSON.stringify(this.players.map(G=>({score:G.score,lives:G.lives,movesLeft:G.movesLeft,uid:G.uid}))),this.lastPlayerIndex=this.currentPlayerIndex,this.lastGameState=this.gameState),this.gameState==="gameOver"){if(g){g.classList.remove("hidden"),g.style.background="",g.style.backdropFilter="";const U=document.getElementById("overlay-animation");U&&(U.innerHTML="")}else console.error("üéÆ ERROR: gameOverlay element not found!");const G=document.getElementById("overlay-text");if(G){const U=[...this.players].sort((q,Y)=>Y.score-q.score);if(U.length>1&&U[0].score===U[1].score)G.innerHTML="ü§ù Oyun Bitti!<br>Berabere! ü§ù";else{const q=U[0];G.innerHTML=`üèÜ Oyun Bitti!<br>Kazanan: ${q.name} üèÜ`}}else console.error("üéÆ ERROR: overlay-text element not found!");const k=[...this.players].sort((U,V)=>V.score-U.score),N=k.length>1&&k[0].score===k[1].score?null:k[0],z=window.practiceMode&&window.practiceMode.active;if(!z&&window.recordGameResultForCurrentUser&&!this.gameResultRecorded&&(window.recordGameResultForCurrentUser(this.players,N),this.gameResultRecorded=!0),!z&&window.uiManager&&this.players&&(window.uiManager.setGameData(auth,this.players),window.uiManager.updateRematchStatus(m.rematchReady||{})),z){this.rematchButton&&this.rematchButton.classList.add("hidden");const U=document.getElementById("practice-menu-button");U&&U.classList.remove("hidden")}else this.rematchButton&&this.rematchButton.classList.remove("hidden");this.waitingText&&this.waitingText.classList.add("hidden")}else if(m.overlayMessage&&m.overlayMessage.text)b.setGameData(auth,m.players,m.currentPlayerIndex),b.showOverlay(m.overlayMessage.text,m.overlayMessage.type,m.overlayMessage.requiresAck,!1);else{const G=(O=this.players[this.currentPlayerIndex])==null?void 0:O.uid;G&&G!==this.lastTurnOwnerUid&&(this.lastTurnOwnerUid=G);const k=(($=this.players[this.currentPlayerIndex])==null?void 0:$.uid)===auth.currentUser.uid,F=this.gameState==="awaiting_ack",N=F&&k;if(!k&&(this.gameState==="playing"||this.gameState==="simulating"||F)&&!N){const U=this.players&&this.players[this.currentPlayerIndex]&&this.players[this.currentPlayerIndex].name||"diƒüer oyuncu";this.isDragging=!1,this.selectedCoin=null;const q=`Sƒ±ra ${U}'da${F?" (onay bekleniyor...)":""}`;window.uiManager&&window.uiManager.showOverlay(q,"info",!1,!1,!0),this.ackButton&&this.ackButton.classList.add("hidden"),this.rematchButton&&this.rematchButton.classList.add("hidden"),this.waitingText&&this.waitingText.classList.add("hidden");const Y=document.getElementById("practice-menu-button");Y&&Y.classList.add("hidden"),window.uiManager.stopFireworks()}else{k&&this.gameState==="playing"&&navigator.vibrate&&navigator.vibrate([50,30,50]),window.uiManager&&window.uiManager.hideOverlay();const U=document.getElementById("overlay-animation");U&&(U.innerHTML=""),this.ackButton&&this.ackButton.classList.add("hidden"),this.rematchButton&&this.rematchButton.classList.add("hidden"),this.waitingText&&this.waitingText.classList.add("hidden"),window.uiManager.stopFireworks()}}},startLocalRender(m){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId);const g=()=>{this.coins=m(),this.draw(),this.animationFrameId=requestAnimationFrame(g)};this.animationFrameId=requestAnimationFrame(g)},stopLocalRender(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)},updateScoreboard(){const m=document.getElementById("player-list");if(!m)return;if(!m.hasAttribute("data-initialized")||m.children.length!==this.players.length){m.innerHTML="";const S=this.hostUid||this.players&&this.players[0]&&this.players[0].uid||null,L=window.practiceMode&&window.practiceMode.active;this.players.forEach((w,E)=>{const H=S?w.uid===S:E===0,O=String.fromCodePoint(128421,65039),$=String.fromCodePoint(128100),G=L?"":H?`<span class="ml-2 inline-flex items-center text-blue-400" title="Host">${O}</span>`:`<span class="ml-2 inline-flex items-center text-slate-300/80" title="Client">${$}</span>`,k=document.createElement("div");k.className="p-3 rounded-lg transition-all duration-300",k.setAttribute("data-player-uid",w.uid),k.setAttribute("data-player-index",E),L?k.innerHTML=`
                            <h3 class="font-bold text-lg text-shadow flex items-center justify-between">
                                <span>${w.name}</span>
                                <span class="text-amber-300 font-semibold player-total-time" title="Toplam oyun s√ºresi">00:00</span>
                            </h3>
                            <div class="flex items-center justify-between text-sm mt-2">
                                <p class="text-shadow">Gol: <span class="font-semibold player-score">${w.score||0}</span></p>
                                <p class="text-shadow player-fouls">Faul: <span class="font-semibold">0</span></p>
                            </div>
                            <div class="text-center mt-2">
                                <p class="text-shadow player-lives">Can: ${"‚ù§Ô∏è".repeat(w.lives||0)}</p>
                            </div>
                        `:k.innerHTML=`
                            <h3 class="font-bold text-lg text-shadow flex items-center">
                                ${w.name}${G}
                                <span class="ml-auto text-amber-300 font-semibold player-turn-time" title="Toplam tur s√ºresi (d√º≈ü√ºnme)">00:00</span>
                            </h3>
                            <div class="flex items-center justify-between text-sm mt-2">
                                <p class="text-shadow">Skor: <span class="font-semibold player-score">${w.score||0}</span></p>
                                <p class="text-shadow player-lives">Can: ${"‚ù§Ô∏è".repeat(w.lives||0)}</p>
                            </div>
                        `,m.appendChild(k),this.scoreboardCache.set(w.uid,{card:k,totalTime:k.querySelector(".player-total-time"),turnTime:k.querySelector(".player-turn-time"),score:k.querySelector(".player-score"),fouls:k.querySelector(".player-fouls span"),lives:k.querySelector(".player-lives"),movesLeft:k.querySelector(".player-moves-left")})}),m.setAttribute("data-initialized","true")}this.players.forEach((S,L)=>{const w=this.scoreboardCache.get(S.uid);if(!w)return;const E=w.card,H=this.rules&&this.rules.minMoves||3,O=S.movesLeft!==void 0?S.movesLeft:H;if(w.movesLeft)O>0?(w.movesLeft.innerHTML=`‚öΩ Gol i√ßin: <span class="font-bold text-amber-300">${O}</span> hamle`,w.movesLeft.classList.remove("hidden","goal-ready-highlight")):(w.movesLeft.innerHTML='‚úÖ <span class="font-bold">Gole Hazƒ±r!</span>',w.movesLeft.classList.remove("hidden"),w.movesLeft.classList.add("goal-ready-highlight"));else{const F=document.createElement("div");F.className="text-center mt-1 text-xs text-slate-400 player-moves-left",O>0?F.innerHTML=`‚öΩ Gol i√ßin: <span class="font-bold text-amber-300">${O}</span> hamle`:(F.innerHTML='‚úÖ <span class="font-bold">Gole Hazƒ±r!</span>',F.classList.add("goal-ready-highlight")),w.card.appendChild(F),w.movesLeft=F}const $=L===this.currentPlayerIndex&&(this.gameState==="playing"||this.gameState==="simulating"||this.gameState==="awaiting_ack"),G=E.classList.contains("bg-amber-500/30");$!==G&&($?E.className="p-3 rounded-lg transition-all duration-300 bg-amber-500/30 border-l-4 border-amber-400":E.className="p-3 rounded-lg transition-all duration-300 bg-slate-700/50");const k=window.practiceMode&&window.practiceMode.active;if(k){const F=window.gameStatsManager&&window.gameStatsManager.gameStartTime?Date.now()-window.gameStatsManager.gameStartTime:0;w.totalTime&&(w.totalTime.textContent=Z(F))}else{let N=window.gameStatsManager&&window.gameStatsManager.playerTurnTimes[S.uid]?window.gameStatsManager.playerTurnTimes[S.uid]:0;$&&window.gameStatsManager&&window.gameStatsManager.currentTurnStartTime&&window.gameStatsManager.currentTurnUid===S.uid&&(N+=Date.now()-window.gameStatsManager.currentTurnStartTime),w.turnTime&&(w.turnTime.textContent=Z(N))}if(w.score&&w.score.textContent!==String(S.score||0)&&(w.score.textContent=S.score||0),k&&w.fouls){const F=window.practiceMode.fouls||0;w.fouls.textContent=F}if(w.lives){const F=w.lives,N=S.lives;let z;window.practiceMode&&window.practiceMode.active&&N===0?z='Can: <span class="text-green-400 font-bold">‚àû (Sƒ±nƒ±rsƒ±z)</span>':N>0?z=`Can: ${"‚ù§Ô∏è".repeat(N)}`:z='Can: <span class="text-red-500 font-bold">Elendi</span>',F.innerHTML!==z&&(F.innerHTML=z)}}),window.updateGameTimerUI&&window.updateGameTimerUI()},draw(){this.renderer.draw(this.coins,{isDragging:this.isDragging,selectedCoin:this.selectedCoin,dragStart:this.dragStart,dragEnd:this.dragEnd})},resizeCanvas(){this.renderer.resizeCanvas(()=>this.draw()),this.resizeFireworksCanvas()},resizeFireworksCanvas(){if(this.fireworksCanvas){const m=s.getBoundingClientRect();this.fireworksCanvas.width=m.width,this.fireworksCanvas.height=m.height}},fireworks:[],fireworksAnimationFrameId:null,fireworksHue:0,cleanup(){this.physicsTimer&&(clearInterval(this.physicsTimer),this.physicsTimer=null),this.stopLocalRender(),window.uiManager&&window.uiManager.stopFireworks(),this.inputHandler&&typeof this.inputHandler.cleanup=="function"&&this.inputHandler.cleanup(),this.players=[],this.coins=[],this.currentPlayerIndex=0,this.gameState="setup",this.lastTurnOwnerUid=null,this.hostUid=null,this.isDragging=!1,this.selectedCoin=null,this.lastMovedCoinId=null,window.practiceMode&&window.practiceMode.active&&(window.practiceMode=null)},init(){this.ackButton=document.getElementById("ack-button"),this.rematchButton=document.getElementById("rematch-button"),this.waitingText=document.getElementById("waiting-text"),this.physicsEngine=new X({LOGICAL_WIDTH:this.LOGICAL_WIDTH,LOGICAL_HEIGHT:this.LOGICAL_HEIGHT,COIN_DIAMETER_RATIO:this.COIN_DIAMETER_RATIO,GOAL_WIDTH_RATIO:this.GOAL_WIDTH_RATIO}),this.inputHandler=new ne(e,this,auth,database),this.inputHandler.init(),this.boundResizeCanvas=()=>this.resizeCanvas(),this.boundAckClick=()=>{var g;const m=((g=this.players[this.currentPlayerIndex])==null?void 0:g.uid)===auth.currentUser.uid;if(this.gameState==="awaiting_ack"&&m)if(window.practiceMode&&window.practiceMode.active){const S={players:this.players,coins:this.coins,currentPlayerIndex:this.currentPlayerIndex,status:this.gameState,lastMovedCoinId:this.lastMovedCoinId,isPathFoulActive:this.isPathFoulActive,collisionOccurredDuringSim:!1,hostUid:this.hostUid,overlayMessage:this.overlayMessage};window.practiceMode.pendingAck=S,document.dispatchEvent(new CustomEvent("practiceAckReady")),this.ackButton.classList.add("hidden"),window.uiManager.stopFireworks()}else database.ref(`games/${window.currentGameId}/acknowledgedTurn`).set(auth.currentUser.uid),this.ackButton.classList.add("hidden"),window.uiManager.stopFireworks()},this.fireworksCanvas=document.getElementById("fireworksCanvas"),this.fireworksCanvas&&(this.fireworksCtx=this.fireworksCanvas.getContext("2d")),this.resizeCanvas(),this.resizeFireworksCanvas(),window.addEventListener("resize",this.boundResizeCanvas),this.ackButton&&this.ackButton.addEventListener("click",this.boundAckClick),this.rematchButton&&b.resetRematchButton()}},window.gameManager.init(),document.addEventListener("profileUpdated",async m=>{const g=m.detail.user;_("mainMenu",screens,()=>D(database,r,n));const S=await window.profileManager.getUserDisplayName(g);userWelcome&&(userWelcome.textContent=`Ho≈ü geldin, ${S}`)}),document.addEventListener("profileHomeClicked",()=>{_("mainMenu",screens,()=>D(database,r,n))});const i=document.getElementById("auth-screen");if(!i)return;window.currentGameId=null,window.screens={auth:i,profile:document.getElementById("profile-screen"),mainMenu:document.getElementById("main-menu-screen"),availableGames:document.getElementById("available-games-screen"),lobby:document.getElementById("lobby-screen"),createGameSettings:document.getElementById("create-game-settings-screen"),practiceSettings:document.getElementById("practice-settings-screen"),game:document.getElementById("main-game-screen")};const r=async m=>window.profileManager?window.profileManager.loadUserProfile(m):null,n=async m=>window.profileManager?window.profileManager.getUserDisplayName(m):m.email?m.email.split("@")[0]:"Oyuncu";window.authManager=new pe(auth,database,window.screens,_,D,r,n),window.userWelcome=document.getElementById("user-welcome"),window.logoutButton=document.getElementById("logout-button"),window.practiceModeButton=document.getElementById("practice-mode-button"),window.practiceMenuButton=document.getElementById("practice-menu-button"),window.createPublicGameButton=document.getElementById("create-public-game-button"),window.availableGamesBackButton=document.getElementById("available-games-back-button"),window.refreshAvailableGamesButton=document.getElementById("refresh-available-games"),window.profileSettingsButton=document.getElementById("profile-settings-button"),window.leaveLobbyButton=document.getElementById("leave-lobby-button"),window.readyButton=document.getElementById("ready-button"),window.startGameFromLobbyButton=document.getElementById("start-game-from-lobby-button"),window.profileHomeButton=document.getElementById("profile-home-button"),window.lobbyHomeButton=document.getElementById("lobby-home-button"),window.gameHomeButton=document.getElementById("game-home-button");const o=document.getElementById("chat-box");window.profileForm=document.getElementById("profile-form"),window.profileFirstname=document.getElementById("profile-firstname"),window.profileLastname=document.getElementById("profile-lastname"),window.profileNickname=document.getElementById("profile-nickname"),window.profilePhone=document.getElementById("profile-phone"),window.profileEmailDisplay=document.getElementById("profile-email-display"),window.currentPassword=document.getElementById("current-password"),window.newPassword=document.getElementById("new-password"),window.newPasswordConfirm=document.getElementById("new-password-confirm"),window.displayRealname=document.getElementById("display-realname"),window.displayNickname=document.getElementById("display-nickname"),window.profileError=document.getElementById("profile-error"),window.profileSuccess=document.getElementById("profile-success"),window.authManager.setupPersistence(),window.authManager.init(),window.authManager.setupAuthStateListener(async m=>{window.currentUser=m,window.profileManager=new he(auth,database),window.profileManager.initEventListeners(),window.DashboardManager=new re(database),await window.DashboardManager.loadStatsFromDB(m.uid),window.gameStatsManager=new se(database,auth,window.gameManager),window.chatManager=new te(auth,database,n),window.chatManager.init(),window.timeRuleManager=new ve(auth,database,window.gameManager,window.uiManager),window.presenceManager=new ye(auth,database,W),window.gameRoomManager=new we(auth,database,{showScreen:_,updateMainMenuUserInfo:D,loadUserProfile:r,getUserDisplayName:n,presenceManager:window.presenceManager,chatManager:window.chatManager,gameStatsManager:window.gameStatsManager,uiManager:window.uiManager,screens}),window.deleteGameRoom=(S,L="manual")=>{window.gameRoomManager&&window.gameRoomManager.deleteGameRoom(S,L)},window.handleReturnToMainMenu=async()=>{window.gameRoomManager&&await window.gameRoomManager.handleReturnToMainMenu()},window.cleanupGameListeners=()=>{},window.simulationManager=new ge(window.gameManager,database,window.gameManager.physicsEngine),window.gameManager.runHostSimulation=(S,L,w)=>{window.simulationManager.runHostSimulation(S,L,w)},window.gameManager.runClientSimulation=(S,L,w)=>{window.simulationManager.runClientSimulation(S,L,w)},window.gameLifecycleManager=new fe(auth,database,window.gameManager,window.gameStatsManager,K),window.networkManager=new oe(auth,database,_,n,W,ee,J,K),window.networkManager.setupEventListeners(),window.gameStateManager=new le(auth,database,{gameManager:window.gameManager,gameStatsManager:window.gameStatsManager,chatManager:window.chatManager,handleReturnToMainMenu,deleteGameRoom,presenceManager:window.presenceManager}),window.networkManager.gameStateManager=window.gameStateManager;const g=await window.profileManager.loadUserProfile(m);!g||!g.nickname?window.profileManager.showProfileScreen():(window.currentGameId||(_("mainMenu",screens,()=>D(database,r,n)),setTimeout(()=>{D(database,r,n)},Q.MENU_UPDATE_DELAY)),setTimeout(()=>{window.gameRoomManager&&window.gameRoomManager.cleanupStaleGames()},Q.CLEANUP_DELAY)),window.gameManager&&window.gameManager.inputHandler&&window.gameManager.inputHandler.init()},()=>{window.currentUser=null,_("auth"),window.gameManager&&window.gameManager.cleanup(),window.currentGameId=null});const l=async m=>{const g=auth.currentUser,S=await window.profileManager.getUserDisplayName(g);window.practiceMode={active:!0,goals:0,fouls:0,attempts:0,settings:m},o&&(o.style.display="none");const L=document.getElementById("player-list");L&&(L.removeAttribute("data-initialized"),L.innerHTML="");const w={uid:g.uid,name:S,score:0,lives:m.lives,initialLives:m.lives,turnCount:0,movesLeft:m.minMoves},E=window.gameManager.LOGICAL_HEIGHT/window.gameManager.LOGICAL_WIDTH,H=window.gameManager.COIN_DIAMETER_RATIO,O=E-E*.1,$=H/2,G=[{id:0,x:.5,y:O,vx:0,vy:0,color:"#c0c0c0",highlight:"#f0f0f0"},{id:1,x:.5-$*4,y:O,vx:0,vy:0,color:"#b87333",highlight:"#e69138"},{id:2,x:.5+$*4,y:O,vx:0,vy:0,color:"#ffd700",highlight:"#fff200"}],k={status:"playing",players:[w],coins:G,currentPlayerIndex:0,lastMovedCoinId:null,isPathFoulActive:!1,collisionOccurredDuringSim:!1,hostUid:g.uid,rules:{collisionFoul:m.collisionFoul,fallFoul:!0,pathFoul:!0,directGoalFoul:!0,sameCoinFoul:m.sameCoinFoul,minMoves:m.minMoves}};_("game"),window.gameManager.ackButton||window.gameManager.init(),window.gameManager.updateState(k),window.gameManager.renderer.assignRandomCoinImages(),window.gameManager.resizeCanvas(),window.gameManager.draw(),window.gameStatsManager.resetGameTimers(),window.gameStatsManager.startGameTimers(k.players,0)},d=async()=>{const m=de(),g=auth.currentUser,S=await window.profileManager.getUserDisplayName(g),w=(await database.ref(`users/${g.uid}/stats`).once("value")).val()||{totalPoints:0},E=J(w.totalPoints),H=database.ref(`games/${m}`),O={host:g.uid,type:"public",league:E.tier,leagueName:E.name,status:"lobby",createdAt:firebase.database.ServerValue.TIMESTAMP,players:{[g.uid]:{email:g.email,displayName:S,ready:!1}}};H.set(O).then(()=>enterLobby(m))},c=()=>{const m=auth.currentUser,g=database.ref(`games/${window.currentGameId}/players/${m.uid}/ready`);g.once("value",S=>{g.set(!S.val())})},u=(m=!1)=>{if(window.currentGameId){const g=window.currentGameId;m||(database.ref(`games/${g}/players/${auth.currentUser.uid}`).remove(),database.ref(`games/${g}`).once("value",w=>{const E=w.val();E&&E.host===auth.currentUser.uid?deleteGameRoom(g,"host_left_lobby"):E&&(E.players?Object.keys(E.players).length:0)===0&&deleteGameRoom(g,"all_players_left")})),window.presenceManager&&(window.presenceManager.cleanup(g),window.presenceManager.removeOwnPresence(g)),window.gameManager&&window.gameManager.cleanup()}window.lobbyAlertShown=!1,window.currentGameId=null,_("mainMenu",screens,()=>D(database,r,n)),m&&W("Oyun kurucu tarafƒ±ndan kapatƒ±ldƒ±.","error",3e3)},h=async()=>{window.networkManager&&window.networkManager.startGameWithToss()};document.addEventListener("practiceFlickReady",()=>{if(window.practiceMode&&window.practiceMode.active&&window.practiceMode.pendingFlick){const{flickData:m,currentState:g}=window.practiceMode.pendingFlick;window.practiceMode.pendingFlick=null,window.simulationManager.runHostSimulation(m,g,"practice")}});const p=m=>window.gameLifecycleManager.getNextStateForTurnEnd(m);document.addEventListener("practiceAckReady",()=>{if(window.practiceMode&&window.practiceMode.active&&window.practiceMode.pendingAck){const m=window.practiceMode.pendingAck;window.practiceMode.pendingAck=null,window.practiceMode.attempts=0;const g=p(m);window.gameManager.updateState(g)}}),practiceModeButton.addEventListener("click",()=>{_("practiceSettings")});const v=document.getElementById("practice-settings-back-button"),f=document.getElementById("practice-settings-form"),y=document.getElementById("practice-min-moves"),T=document.getElementById("practice-min-moves-display");y&&T&&y.addEventListener("input",m=>{T.textContent=m.target.value}),v&&v.addEventListener("click",()=>{_("mainMenu",screens,()=>D(database,r,n))}),f&&f.addEventListener("submit",m=>{var S,L,w,E;m.preventDefault();const g={collisionFoul:((S=document.getElementById("practice-collision-foul"))==null?void 0:S.checked)??!0,sameCoinFoul:((L=document.getElementById("practice-same-coin-foul"))==null?void 0:L.checked)??!0,lives:parseInt(((w=document.getElementById("practice-lives"))==null?void 0:w.value)??0),minMoves:parseInt(((E=document.getElementById("practice-min-moves"))==null?void 0:E.value)??3)};l(g)}),practiceMenuButton.addEventListener("click",()=>{window.practiceMode={active:!1},o&&(o.style.display=""),window.gameStatsManager.stopGameTimers(),window.gameManager&&window.gameManager.cleanup(),window.gameStatsManager&&window.gameStatsManager.resetGameTimers(),_("mainMenu",screens,()=>D(database,r,n))}),createPublicGameButton&&createPublicGameButton.addEventListener("click",d),availableGamesBackButton&&availableGamesBackButton.addEventListener("click",()=>{_("mainMenu",screens,()=>D(database,r,n))}),refreshAvailableGamesButton&&refreshAvailableGamesButton.addEventListener("click",async()=>{const m=refreshAvailableGamesButton.querySelector("svg");m&&(m.style.animation="spin 0.5s linear",setTimeout(()=>{m.style.animation=""},500)),await window.networkManager.loadAvailableGames(),W("Oyunlar yenilendi","success",2e3)}),leaveLobbyButton.addEventListener("click",()=>u(!1)),readyButton.addEventListener("click",c),startGameFromLobbyButton.addEventListener("click",h),profileHomeButton&&profileHomeButton.addEventListener("click",()=>{_("mainMenu",screens,()=>D(database,r,n))}),lobbyHomeButton&&lobbyHomeButton.addEventListener("click",()=>{u(!1),_("mainMenu",screens,()=>D(database,r,n))}),gameHomeButton&&gameHomeButton.addEventListener("click",async()=>{await confirm("Oyunu bƒ±rakƒ±p ana men√ºye d√∂nmek istediƒüinizden emin misiniz?")&&handleReturnToMainMenu()});const I=document.getElementById("refresh-leaderboard");I&&I.addEventListener("click",()=>{const m=I.querySelector("svg");m&&m.classList.add("animate-spin"),window.DashboardManager&&window.DashboardManager.updateLeaderboard().then(()=>{m&&setTimeout(()=>{m.classList.remove("animate-spin")},500)}).catch(()=>{m&&m.classList.remove("animate-spin")})});const x=document.getElementById("rematch-button");x&&x.addEventListener("click",()=>{const m=window.currentGameId,g=auth.currentUser.uid;if(!m||!g)return;x.innerHTML=`
                <span class="flex items-center gap-3 text-lg">
                    <svg class="w-6 h-6 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Hazƒ±r! ‚úì
                </span>
            `,x.classList.remove("animate-pulse","from-green-500","to-emerald-600","hover:from-green-600","hover:to-emerald-700","hover:scale-110"),x.classList.add("from-blue-500","to-blue-600","cursor-not-allowed"),x.disabled=!0,database.ref(`games/${m}/rematchReady/${g}`).set(!0).catch(L=>{console.error("Error setting rematch ready:",L),window.uiManager&&window.uiManager.resetRematchButton()})});const M=document.getElementById("show-rules-button"),P=document.getElementById("game-rules-modal"),A=document.getElementById("close-game-rules-modal"),R=document.getElementById("ok-game-rules-modal"),B=document.getElementById("game-rules-content"),C=m=>{if(!B||!m){B.innerHTML="<p>Oyun kurallarƒ± mevcut deƒüil.</p>";return}const g={collisionFoul:!0,sameCoinFoul:!0,initialLives:3,minMoves:3,...m},S=g.collisionFoul?"‚úÖ":"‚ùå",L=g.sameCoinFoul?"‚úÖ":"‚ùå";let w=`
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-slate-200">
                <div class="flex items-center gap-2 bg-slate-700/50 p-3 rounded-lg">
                    <span class="text-2xl">${S}</span>
                    <span>√áarpƒ±≈üma Faul√º</span>
                </div>
                <div class="flex items-center gap-2 bg-slate-700/50 p-3 rounded-lg">
                    <span class="text-2xl">${L}</span>
                    <span>√úst √úste Oynama</span>
                </div>
                <div class="flex items-center gap-2 bg-slate-700/50 p-3 rounded-lg">
                    <span class="text-2xl">‚ù§Ô∏è</span>
                    <span>Can: <span class="font-bold text-white">${g.initialLives||3}</span></span>
                </div>
                <div class="flex items-center gap-2 bg-slate-700/50 p-3 rounded-lg">
                    <span class="text-2xl">üéØ</span>
                    <span>Min. Hamle: <span class="font-bold text-white">${g.minMoves||3}</span></span>
                </div>
        `;g.timeRule&&g.timeRule.enabled&&(w+=`
                <div class="flex items-center gap-2 col-span-1 sm:col-span-2 bg-slate-700/50 p-3 rounded-lg">
                    <span class="text-2xl">‚è±Ô∏è</span>
                    <span>S√ºre Limiti: <span class="font-bold text-amber-300">${g.timeRule.timeLimitMinutes||5} dk</span></span>
                </div>
            `),w+="</div>",B.innerHTML=w};M&&M.addEventListener("click",()=>{window.gameManager&&window.gameManager.rules?C(window.gameManager.rules):B.innerHTML="<p>Oyun kurallarƒ± y√ºklenemedi. L√ºtfen oyuna ba≈üladƒ±ktan sonra tekrar deneyin.</p>",P.classList.remove("hidden")}),A&&A.addEventListener("click",()=>{P.classList.add("hidden")}),R&&R.addEventListener("click",()=>{P.classList.add("hidden")}),window.recordGameResultForCurrentUser=async function(m,g){if(!window.currentUser||!window.DashboardManager)return;const S=m.find(k=>k.uid===window.currentUser.uid);if(!S)return;let L;const w=S.score||0,E=g&&g.score||0,H=Math.max(...m.map(k=>k.score||0));m.filter(k=>(k.score||0)===H).length>1&&w===H?L="draw":g&&w>E||g&&w===E&&S.uid===g.uid?L="win":g&&w===E?L="draw":L="loss";const G=window.DashboardManager.recordGameResult(L,"online");window.lastGamePointsEarned=G},window.addEventListener("beforeunload",async m=>{if(!window.currentGameId)return;const g=database.ref(`games/${window.currentGameId}`);try{const L=(await g.once("value")).val();if(L){const w=L.status;(w==="playing"||w==="waiting"||w==="awaiting_ack"||w==="simulating")&&g.update({status:"abandoned",abandonedBy:window.currentUser?window.currentUser.uid:"unknown",abandonedAt:Date.now(),abandonMessage:`${window.currentUser&&window.currentUser.displayName||"Bir oyuncu"} oyundan ayrƒ±ldƒ± (tarayƒ±cƒ± kapatƒ±ldƒ±).`})}}catch(S){console.error("Error in beforeunload handler:",S)}}),window.gameManager.renderer.setConstants({LOGICAL_WIDTH:window.gameManager.LOGICAL_WIDTH,LOGICAL_HEIGHT:window.gameManager.LOGICAL_HEIGHT,COIN_DIAMETER_RATIO:window.gameManager.COIN_DIAMETER_RATIO,GOAL_WIDTH_RATIO:window.gameManager.GOAL_WIDTH_RATIO}),window.gameManager.renderer.loadCoinImages(()=>{window.gameManager.draw()}),window.gameManager.renderer.loadWoodTexture(()=>{window.gameManager.draw()})});
